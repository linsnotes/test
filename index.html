<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>听写 · Tingxie App</title>
  <meta name="theme-color" content="#6c5ce7" />
  <style>
    :root{
      --bg: #0f1226; /* deep indigo */
      --panel: rgba(255,255,255,0.08);
      --panel-2: rgba(255,255,255,0.14);
      --text: #f5f7ff;
      --muted: #c8cff7;
      --brand: #6c5ce7; /* purple */
      --brand-2: #00d4ff; /* aqua */
      --ok: #2ecc71;
      --warn: #f1c40f;
      --err: #ff7675;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text); background:
        radial-gradient(1200px 600px at -10% -10%, #1b1644 0%, transparent 50%),
        radial-gradient(1200px 600px at 110% 10%, #12233f 0%, transparent 50%),
        radial-gradient(1200px 600px at 50% 120%, #1a2a6c 0%, transparent 50%),
        var(--bg);
    }

    .container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

    header{
      position: sticky; top:0; z-index: 5; backdrop-filter: saturate(1.2) blur(8px);
      background: linear-gradient(180deg, rgba(10,12,30,0.8), rgba(10,12,30,0.2));
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .nav{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding: 14px 0; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:0.2px; }
    .logo{
      width: 34px; height: 34px; border-radius: 12px; background: linear-gradient(135deg, var(--brand), var(--brand-2));
      box-shadow: var(--shadow);
    }
    .nav-actions{ display:flex; gap:10px; align-items:center; }

    .btn{
      appearance:none; border:none; cursor:pointer; color: var(--text); font-weight: 700;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      padding: 10px 14px; border-radius: 12px; box-shadow: var(--shadow); transition: transform .06s ease, filter .2s;
    }
    .btn.secondary{ background: var(--panel-2); font-weight:600; box-shadow: none; border:1px solid rgba(255,255,255,0.1); }
    .btn.ghost{ background: transparent; border:1px solid rgba(255,255,255,0.18); box-shadow:none; }
    .btn:active{ transform: translateY(1px) scale(0.99); }
    .btn[disabled]{ opacity: .5; cursor:not-allowed; }

    .tag{ font-size: 12px; padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.15); }

    .grid{ display:grid; gap:16px; }
    @media (min-width: 900px){ .grid.cols-2{ grid-template-columns: 1fr 1fr; } }

    .card{ background: var(--panel); border:1px solid rgba(255,255,255,0.12); border-radius: 18px; padding: 16px; box-shadow: var(--shadow); }
    .card h3{ margin:6px 0 8px; }
    .muted{ color: var(--muted); opacity:.9; }

    input, select{ width: 100%; padding: 12px 12px; border-radius: 12px; border:1px solid rgba(255,255,255,0.14); background: rgba(0,0,0,0.2); color: var(--text); outline: none; font-size:16px; }
    input::placeholder{ color: #b8c0ff; opacity:.7; }
    label{ font-size: 13px; opacity:.9; }

    .row{ display:flex; gap:12px; align-items:center; flex-wrap: wrap; }

    .list{ display:flex; flex-direction:column; gap:12px; }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 12px; border-radius: 14px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); }
    .item .title{ font-weight:700; }

    .hidden{ display:none !important; }

    .pill{ display:inline-flex; align-items:center; gap:8px; padding: 8px 12px; border-radius: 999px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); }

    .switch{ position:relative; display:inline-block; width: 48px; height: 26px; }
    .switch input{ display:none; }
    .slider{ position:absolute; cursor:pointer; inset:0; background: rgba(255,255,255,0.2); transition:.2s; border-radius: 999px; }
    .slider:before{ content:""; position:absolute; height: 22px; width: 22px; left: 2px; top: 2px; background: white; border-radius: 50%; transition:.2s; }
    .switch input:checked + .slider{ background: linear-gradient(135deg, var(--brand), var(--brand-2)); }
    .switch input:checked + .slider:before{ transform: translateX(22px); }

    .progress{ height: 10px; border-radius: 999px; background: rgba(255,255,255,0.12); overflow: hidden; }
    .progress > span{ display:block; height: 100%; background: linear-gradient(90deg, var(--brand), var(--brand-2)); width:0%; transition: width .25s ease; }

    .toast{ position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color:#fff; padding: 10px 14px; border-radius: 12px; z-index: 20; box-shadow: var(--shadow); }

    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-weight:700; letter-spacing: .2px; background: rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 6px; }

    .blink{ animation: blink 1s step-start 3; }
    @keyframes blink { 50% { opacity: 0.5; } }

    .result-badge{ padding:4px 8px; border-radius:8px; font-size:12px; font-weight:800; }
    .ok{ background: rgba(46, 204, 113, .18); border:1px solid rgba(46, 204, 113, .35); }
    .err{ background: rgba(231, 76, 60, .18); border:1px solid rgba(231, 76, 60, .35); }
    .skip{ background: rgba(241, 196, 15, .18); border:1px solid rgba(241, 196, 15, .35); }

    @media (max-width: 420px){
      .nav{ padding: 10px 0; }
      .brand div:first-child{ font-size:16px; }
      h2{ font-size: 20px; }
      h3{ font-size: 16px; }
      .btn{ padding: 9px 12px; border-radius: 10px; }
      .item{ padding: 10px; }
      .pill{ padding: 6px 10px; }
      .card{ padding: 12px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div style="font-size:18px; line-height:1;">听写 · Tingxie</div>
          <div style="font-size:12px; opacity:.8;">Dictation app</div>
        </div>
      </div>
      <div class="nav-actions">
        <span class="tag" id="ttsStatus">TTS: checking…</span>
        <button class="btn secondary" id="openSettingsBtn" title="Speech & options">Settings</button>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- SCREEN: HOME / SOURCES -->
    <section id="screen-home" class="grid cols-2">
      <div class="card">
        <h2>Choose where to load your exercises</h2>
        <p class="muted">You can browse a <b>Built‑in Library</b> or paste a <b>Custom Exercise</b> sheet ID.</p>
        <div class="grid cols-2">
          <div class="card" style="min-height:220px;">
            <h3>Built-in Library</h3>
            <p class="muted">Pick from the built‑in list.</p>
            <div class="row">
              <button class="btn ghost" id="reloadMasterBtn" title="Refresh" aria-label="Refresh">↻</button>
            </div>
            <label for="masterSelect" style="margin-top:8px; display:block;">Built‑in sheets</label>
            <select id="masterSelect"></select>
            <div class="row" style="margin-top:8px;">
              <button class="btn" id="openMasterBtn" disabled>Open Selected</button>
            </div>
            
          </div>

          <div class="card" style="min-height:220px;">
            <h3>Custom Exercise</h3>
            <p class="muted">Paste a <b>Spreadsheet ID</b> that contains one sheet with columns: <b>title</b>, <b>words</b> (comma-separated; English or Chinese).</p>
            <label for="customId">Google Spreadsheet ID</label>
            <input id="customId" type="text" placeholder="e.g. 1A2bC3dE4F..." autocomplete="off"/>
            <div class="row" style="margin-top:8px;">
              <button class="btn" id="loadCustomBtn">Load Exercise Sheet</button>
            </div>
            <div id="customList" class="list" style="margin-top:10px; max-height:260px; overflow:auto;"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>How to start</h2>
        <ul class="muted" style="line-height:1.7; padding-left: 18px;">
          <li>Pick from the <b>Built‑in Library</b> or paste a <b>Custom Exercise</b> Spreadsheet ID.</li>
          <li>Select an <b>exercise</b> and press <b>Start</b>.</li>
          <li>Listen, type your answer, and use <b>Try again</b> / <b>Skip</b> / <b>Show answer</b>.</li>
          <li>View your <b>summary</b> at the end.</li>
        </ul>
        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" id="demoBtn" title="Try a minimal demo with local sample">Quick Demo</button>
          <span class="pill" style="margin-left:8px;">Tip: Press <span class="kbd">Enter</span> to submit</span>
        </div>
      </div>
    </section>

    <!-- SCREEN: EXERCISE PICKER -->
    <section id="screen-picker" class="card hidden">
      <div class="row" style="justify-content:space-between;">
        <h2 id="pickerTitle">Exercises</h2>
        <div class="row">
          <label class="pill" title="Randomize order when starting">
            <span>Randomize</span>
            <label class="switch" style="margin-left:8px;">
              <input type="checkbox" id="randomizeToggle" />
              <span class="slider"></span>
            </label>
          </label>
          <button class="btn secondary" id="backHomeBtn">Back</button>
        </div>
      </div>
      <div id="exerciseList" class="list" style="margin-top:10px;"></div>
    </section>

    <!-- SCREEN: RUN -->
    <section id="screen-run" class="card hidden">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <h2 id="runTitle">Exercise</h2>
          <div class="muted" id="runMeta"></div>
        </div>
        <div class="row">
          <button class="btn secondary" id="revealSettingsBtn">Settings</button>
          <button class="btn secondary" id="stopBtn">Stop</button>
          <button class="btn secondary" id="homeBtnRun">Home</button>
        </div>
      </div>

      <div style="margin:12px 0;" class="progress" aria-label="Progress">
        <span id="progressBar" style="width:0%"></span>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div>
            <div class="muted" style="font-size:13px;">Word <span id="idxNow">1</span> / <span id="idxTotal">1</span></div>
            <div style="font-size:22px; font-weight:800;" id="promptWord">(playing…)</div>
          </div>
          <div class="row">
            <button class="btn" id="playBtn" title="Play again">▶️ Play</button>
          </div>
        </div>
        <div style="margin-top:10px;" class="row">
          <input id="answerInput" type="text" placeholder="Type what you hear…" autocomplete="off" />
          <button class="btn" id="submitBtn">Submit</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <button class="btn secondary" id="tryAgainBtn">Try again</button>
          <button class="btn secondary" id="skipBtn">Skip</button>
          <button class="btn secondary" id="showBtn">Show answer</button>
        </div>
        <div id="feedback" class="muted" style="margin-top:8px;"></div>
      </div>

      
    </section>

    <!-- SCREEN: SUMMARY -->
    <section id="screen-summary" class="card hidden">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <h2>Summary</h2>
          <div class="muted" id="summaryTitle"></div>
        </div>
        <div class="row">
          <button class="btn secondary" id="backToPicker">Back to exercises</button>
          <button class="btn secondary" id="homeBtnSummary">Home</button>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:10px;">
        <div class="card">
          <h3>Stats</h3>
          <div class="row" style="gap:16px; flex-wrap:wrap;">
            <div class="pill">Words: <b id="sumTotal">0</b></div>
            <div class="pill">Correct: <b id="sumCorrect">0</b></div>
            <div class="pill">Skipped: <b id="sumSkipped">0</b></div>
            <div class="pill">Accuracy: <b id="sumAcc">0%</b></div>
            <div class="pill">Time: <b id="sumTime">0s</b></div>
          </div>
        </div>
        <div class="card">
          <h3>What needs practice</h3>
          <div id="reviewList" class="list"></div>
        </div>
      </div>
      <div class="card" style="margin-top:10px;">
        <h3>All results</h3>
        <div id="resultsTable" class="list"></div>
      </div>
    </section>

    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

    <!-- SETTINGS MODAL (simple) -->
    <dialog id="settingsModal" style="border:none; border-radius:16px; background: rgba(20,22,45,0.95); color:var(--text); width:min(720px, 92vw);">
      <form method="dialog" style="margin:0;">
        <div class="card" style="box-shadow:none; background:transparent; border:none;">
          <div class="row" style="justify-content:space-between;">
            <h2>App Settings</h2>
            <button class="btn secondary" value="close">Close</button>
          </div>
          <div class="grid cols-2" style="margin-top:8px;">
            <div class="card">
              <h3>Voices</h3>
              <label>English Voice
                <select id="enVoice2"></select>
              </label>
              <div style="height:6px;"></div>
              <label>中文语音
                <select id="zhVoice2"></select>
              </label>
              <div class="row" style="margin-top:6px;">
                <button class="btn secondary" id="testEN2">Test EN</button>
                <button class="btn secondary" id="testZH2">测试中文</button>
              </div>
            </div>
            <div class="card">
              <h3>Speech</h3>
              <label>Rate
                <input id="rate2" type="range" min="0.5" max="1.5" step="0.05" value="1" />
              </label>
              <div style="height:8px;"></div>
              <label>Pitch
                <input id="pitch2" type="range" min="0.5" max="1.5" step="0.05" value="1" />
              </label>
            </div>
          </div>
        </div>
      </form>
    </dialog>
  </main>

  <script>
  // ======= CONFIG =======
  const MASTER_SPREADSHEET_ID = "1ee1TP1rHK47sESfpuuqA0MyBae5NczxEO7hCYB0_xD8"; // <-- Replace with your master sheet ID (title, sheet id)

  // ======= STATE =======
  const state = {
    ttsReady: false,
    voices: [],
    selected: { en: null, zh: null, rate: 1, pitch: 1, autoplay: true },
    source: null, // {type:'master'|'custom', id}
    picker: [], // list of {label, id} for master OR list of exercises for custom
    exerciseSheet: null, // current sheet object
    exerciseRows: [], // [{title, words:[...]}]
    current: {
      title: '',
      words: [],
      order: [],
      i: 0,
      startedAt: 0,
      perWordStart: 0,
      results: [] // [{word, correct, attempts, skipped, shownAnswer, timeMs}]
    }
  };

  // ======= HELPERS =======
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  function toast(msg, ms=1800){
    const t = $('#toast'); t.textContent = msg; t.classList.remove('hidden');
    setTimeout(()=> t.classList.add('hidden'), ms);
  }

  function savePrefs(){
    localStorage.setItem('tingxie_prefs', JSON.stringify({
      en: state.selected.en?.name || null,
      zh: state.selected.zh?.name || null,
      rate: state.selected.rate,
      pitch: state.selected.pitch,
      randomize: $('#randomizeToggle').checked,
      autoplay: state.selected.autoplay,
      lastCustom: $('#customId').value || ''
    }));
  }
  function loadPrefs(){
    try{
      const p = JSON.parse(localStorage.getItem('tingxie_prefs')||'{}');
      if(p.rate) state.selected.rate = p.rate;
      if(p.pitch) state.selected.pitch = p.pitch;
      if(p.randomize!=null) $('#randomizeToggle').checked = p.randomize;
      if(p.autoplay!=null) state.selected.autoplay = p.autoplay;
      if(p.lastCustom) $('#customId').value = p.lastCustom;
      // voice names resolved after voices load
    }catch{}
  }

  function csvParse(text){
    const lines = text.replace(/\r\n?/g, "\n").split("\n").filter(l=>l.trim().length>0);
    const rows = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(cell => {
      let c = cell.trim();
      if(c.startsWith('"') && c.endsWith('"')) c = c.slice(1,-1).replace(/""/g,'"');
      return c;
    }));
    return rows;
  }

  function normalizeHeader(h){ return h.trim().toLowerCase().replace(/\s+/g,' '); }

  function getCsvUrl(spreadsheetId){
    return `https://docs.google.com/spreadsheets/d/${encodeURIComponent(spreadsheetId)}/export?format=csv`;
  }

  async function fetchSheetCsv(spreadsheetId){
    const url = getCsvUrl(spreadsheetId);
    const res = await fetch(url);
    if(!res.ok) throw new Error(`Failed to load CSV (${res.status})`);
    return await res.text();
  }

  function isChinese(str){ return /[\p{Script=Han}]/u.test(str); }

  function splitWords(raw){
    if(!raw) return [];
    return raw
      .split(/[，,]/g)
      .map(s=>s.replace(/\s+/g,' ').trim())
      .filter(Boolean);
  }

  function normEnglish(s){
    return (s||'').toLocaleLowerCase().normalize('NFC').replace(/[^\p{Letter}\p{Number}]+/gu,'');
  }
  function normChinese(s){
    return (s||'').normalize('NFC').replace(/\s+/g,'');
  }
  function isCorrect(expected, input){
    if(isChinese(expected)){
      return normChinese(expected) === normChinese(input);
    } else {
      return normEnglish(expected) === normEnglish(input);
    }
  }

  function fmtMs(ms){
    const s = Math.round(ms/1000);
    if(s < 60) return s+"s";
    const mm = Math.floor(s/60), ss = s%60;
    return `${mm}m ${ss}s`;
  }

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }

  // ======= TTS =======
  function setTtsStatus(text){ $('#ttsStatus').textContent = text; }

  function loadVoices(){
    let list = speechSynthesis.getVoices();
    if(list.length){ onVoices(list); }
  }

  function onVoices(list){
    state.ttsReady = true; state.voices = list.slice().sort((a,b)=>a.lang.localeCompare(b.lang) || a.name.localeCompare(b.name));
    setTtsStatus(`TTS ready (${state.voices.length} voices)`);

    // Populate selects (two places: inline settings & modal)
    const en = state.voices.filter(v=>/^en[-_]/i.test(v.lang));
    const zh = state.voices.filter(v=>/^zh[-_]/i.test(v.lang));

    function fill(select, voices){ if(!select) return; select.innerHTML = voices.map(v=>`<option value="${encodeURIComponent(v.name)}">${v.name} · ${v.lang}</option>`).join('');
    }

    [$('#enVoice'), $('#enVoice2')].filter(Boolean).forEach(sel=> fill(sel, en));
    [$('#zhVoice'), $('#zhVoice2')].filter(Boolean).forEach(sel=> fill(sel, zh));

    // Restore previous voice by name
    const prefs = JSON.parse(localStorage.getItem('tingxie_prefs')||'{}');
    if(prefs.en){ const v = state.voices.find(v=>v.name===prefs.en); if(v){ state.selected.en=v; [$('#enVoice'),$('#enVoice2')].forEach(s=>{ if(s) s.value=encodeURIComponent(v.name); }); } }
    if(prefs.zh){ const v = state.voices.find(v=>v.name===prefs.zh); if(v){ state.selected.zh=v; [$('#zhVoice'),$('#zhVoice2')].forEach(s=>{ if(s) s.value=encodeURIComponent(v.name); }); } }

    // Defaults if none chosen
    if(!state.selected.en && en[0]){ state.selected.en = en[0]; [$('#enVoice'),$('#enVoice2')].forEach(s=>{ if(s) s.value=encodeURIComponent(en[0].name); }); }
    if(!state.selected.zh && zh[0]){ state.selected.zh = zh[0]; [$('#zhVoice'),$('#zhVoice2')].forEach(s=>{ if(s) s.value=encodeURIComponent(zh[0].name); }); }
  }

  function getVoiceForWord(word){
    const zh = isChinese(word);
    const preferred = zh ? state.selected.zh : state.selected.en;
    if(preferred) return preferred;
    // fallback
    const list = zh ? state.voices.filter(v=>/^zh/i.test(v.lang)) : state.voices.filter(v=>/^en/i.test(v.lang));
    return list[0] || state.voices[0] || null;
  }

  function speak(text){
    if(!('speechSynthesis' in window)) { toast('Speech Synthesis not supported in this browser.'); return; }
    const voice = getVoiceForWord(text);
    const u = new SpeechSynthesisUtterance(text);
    if(voice){ u.voice = voice; u.lang = voice.lang; }
    u.rate = state.selected.rate; u.pitch = state.selected.pitch;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // ======= UI FLOW =======
  function show(id){
    ['#screen-home', '#screen-picker', '#screen-run', '#screen-summary'].forEach(sel=> $(sel).classList.add('hidden'));
    $(id).classList.remove('hidden');
  }

  function buildMasterList(rows){
    const sel = $('#masterSelect');
    const openBtn = $('#openMasterBtn');
    if(sel){
      sel.innerHTML = '';
      const ph = document.createElement('option');
      ph.value = ''; ph.textContent = '— Select —'; ph.disabled = true; ph.selected = true;
      sel.appendChild(ph);
    }
    if(!rows.length){
      if(sel){ sel.innerHTML = '<option value="" disabled selected>No items</option>'; }
      if(openBtn){ openBtn.disabled = true; }
      return;
    }
    rows.forEach(r=>{
      if(sel){ const opt = document.createElement('option'); opt.value = r.id; opt.textContent = r.title; sel.appendChild(opt); }
    });
    if(openBtn){ openBtn.disabled = false; }
  }

  function tryAgain(){
    $('#answerInput').value=''; $('#answerInput').focus(); $('#feedback').textContent='';
  }

  function skipWord(){
    const expected = currentWord();
    const timeMs = performance.now() - state.current.perWordStart;
    state.current.results.push({word: expected, correct: false, attempts: '—', skipped: true, shownAnswer: false, timeMs});
    $('#feedback').innerHTML = `<span class=\"result-badge skip\">Skipped</span> It was: <b>${expected}</b>`;
    nextWord();
  }

  function showAnswer(){
    const expected = currentWord();
    const timeMs = performance.now() - state.current.perWordStart;
    state.current.results.push({word: expected, correct: false, attempts: '—', skipped: false, shownAnswer: true, timeMs});
    $('#feedback').innerHTML = `Answer: <b>${expected}</b>`;
    nextWord();
  }

  function nextWord(){
    const {words, order} = state.current;
    $('#answerInput').value='';
    state.current.i++;
    updateProgress();
    if(state.current.i >= words.length){
      finishExercise();
    } else {
      if(state.selected.autoplay){ setTimeout(playCurrent, 350); }
      else { $('#promptWord').textContent = '(ready)'; }
    }
  }

  function finishExercise(){
    $('#progressBar').style.width = '100%';
    const totalMs = performance.now() - state.current.startedAt;

    // Aggregate
    const total = state.current.words.length;
    const correct = state.current.results.filter(r=>r.correct).length;
    const skipped = state.current.results.filter(r=>r.skipped).length;
    const accuracy = total ? Math.round((correct/total)*100) : 0;

    $('#summaryTitle').textContent = state.current.title;
    $('#sumTotal').textContent = total;
    $('#sumCorrect').textContent = correct;
    $('#sumSkipped').textContent = skipped;
    $('#sumAcc').textContent = accuracy + '%';
    $('#sumTime').textContent = fmtMs(totalMs);

    const review = $('#reviewList'); review.innerHTML='';
    state.current.results.filter(r=>!r.correct).forEach(r=>{
      const d = document.createElement('div'); d.className='item';
      d.innerHTML = `<div><div class=\"title\">${r.word}</div><div class=\"muted\">${r.skipped? 'skipped' : r.shownAnswer? 'gave up' : 'incorrect'}</div></div>`;
      const btn = document.createElement('button'); btn.className='btn secondary'; btn.textContent='Practice';
      btn.onclick = ()=> speak(r.word);
      d.appendChild(btn); review.appendChild(d);
    });

    const table = $('#resultsTable'); table.innerHTML='';
    state.current.results.forEach((r,idx)=>{
      const d = document.createElement('div'); d.className='item';
      const badge = r.correct? '<span class=\"result-badge ok\">✓</span>' : (r.skipped? '<span class=\"result-badge skip\">⏭</span>' : '<span class=\"result-badge err\">✗</span>');
      d.innerHTML = `<div><div class=\"title\">${idx+1}. ${r.word}</div><div class=\"muted\">${badge} ${r.correct? 'correct' : r.skipped? 'skipped' : r.shownAnswer? 'gave up' : 'wrong'}, time: ${fmtMs(r.timeMs)}</div></div>`;
      table.appendChild(d);
    });

    show('#screen-summary');
  }

  // Helper functions for exercises (added)
  function buildExercisePicker(items, sourceLabel='Built-in'){
    state.exerciseRows = items;
    $('#pickerTitle').textContent = `${sourceLabel} — Exercises`;
    const list = $('#exerciseList'); list.innerHTML='';
    items.forEach((it, idx)=>{
      const d = document.createElement('div'); d.className='item';
      d.innerHTML = `<div><div class="title">${it.title||('Exercise '+(idx+1))}</div><div class="muted">${it.words.length} words</div></div>`;
      const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Start';
      btn.onclick = ()=> startExercise(idx);
      d.appendChild(btn); list.appendChild(d);
    });
    show('#screen-picker');
  }

  function startExercise(idx){
    const ex = state.exerciseRows[idx]; if(!ex) return;
    state.current.title = ex.title || 'Exercise';
    state.current.words = ex.words.slice();
    state.current.order = state.current.words.map((_,i)=>i);
    if($('#randomizeToggle').checked) state.current.order = shuffle(state.current.order);
    state.current.i = 0; state.current.results = []; state.current.startedAt = performance.now();
    state.current.perWordStart = 0; state.current.attemptsForWord = 0;
    $('#runTitle').textContent = state.current.title;
    $('#runMeta').textContent = `${state.current.words.length} words`;
    $('#promptWord').textContent = '(playing…)';
    $('#idxTotal').textContent = state.current.words.length;
    $('#answerInput').value=''; $('#feedback').textContent='';
    show('#screen-run');
    updateProgress();
    playCurrent();
  }

  function currentWord(){
    const {words, order, i} = state.current; const idx = (order && order[i] != null) ? order[i] : i; return words[idx] || '';
  }

  function playCurrent(){
    const w = currentWord();
    state.current.perWordStart = performance.now();
    $('#promptWord').textContent = '(playing…)';
    if(w) speak(w);
    $('#answerInput').focus();
  }

  function updateProgress(){
    const i = state.current.i; const total = state.current.words.length;
    $('#idxNow').textContent = Math.min(i+1, total);
    $('#idxTotal').textContent = total;
    const pct = total ? Math.round((i/total)*100) : 0;
    $('#progressBar').style.width = pct + '%';
  }

  function submitAnswer(){
    const input = $('#answerInput').value.trim();
    const expected = currentWord();
    if(!expected) return;
    const timeMs = performance.now() - state.current.perWordStart;
    state.current.attemptsForWord = (state.current.attemptsForWord||0) + 1;
    if(isCorrect(expected, input)){
      state.current.results.push({word: expected, correct: true, attempts: state.current.attemptsForWord, skipped: false, shownAnswer: false, timeMs});
      $('#feedback').innerHTML = '<span class="result-badge ok">Correct</span>';
      nextWord();
    } else {
      $('#feedback').innerHTML = `<span class=\"result-badge err\">Wrong</span> Try again, or <b>Skip</b> / <b>Show answer</b>.`;
      $('#answerInput').classList.add('blink'); setTimeout(()=> $('#answerInput').classList.remove('blink'), 800);
      $('#answerInput').focus();
    }
  }

  // ======= LOADERS =======
  async function loadMaster(){
    const card = document.querySelector('#masterSelect')?.closest('.card');
    try{
      if(!MASTER_SPREADSHEET_ID || MASTER_SPREADSHEET_ID === 'xxxxx'){
        if(card) card.style.display='none';
        return; // silently hide if not set
      }
      if(card) card.style.display='';
      
      const csv = await fetchSheetCsv(MASTER_SPREADSHEET_ID);
      // trim empty lines/rows
      const rows = csvParse(csv).filter(r=> (r||[]).some(c=> String(c||'').trim() !== ''));
      if(!rows.length) throw new Error('Empty sheet');

      // Always skip the first row so users can use any header/note text
      const data = rows.slice(1).map(r=>{
        const title = (r[0]||'').toString().trim();
        let id = (r[1]||'').toString().trim();
        // Accept full Google Sheets URLs or bare IDs
        const m = id.match(/\/d\/([A-Za-z0-9-_]+)/); if(m) id = m[1];
        return { title, id };
      }).filter(x=> x.title && x.id);

      buildMasterList(data);
    }catch(err){
      console.warn('Master load failed:', err.message);
      if(card) card.style.display='none';
    }
  }

  async function loadExerciseSheet(sheetId, sourceLabel='Custom'){
    try{
      show('#screen-home');
      $('#customList').innerHTML = '';
      $('#exerciseList').innerHTML = '';
      const csv = await fetchSheetCsv(sheetId);
      const rows = csvParse(csv);
      if(!rows.length) throw new Error('Empty sheet');
      const headers = rows[0].map(normalizeHeader);
      const iTitle = headers.indexOf('title');
      const iWords = headers.indexOf('words');
      if(iTitle < 0 || iWords < 0) throw new Error('Exercise sheet must have headers: title, words');
      const items = rows.slice(1).filter(r=>r[iTitle] || r[iWords]).map(r=>({
        title: (r[iTitle]||'').trim(),
        words: splitWords(r[iWords])
      })).filter(x=>x.words.length>0);
      if(!items.length) throw new Error('No exercises found');
      buildExercisePicker(items, sourceLabel);
      state.source = {type:'custom', id: sheetId};
      savePrefs();
    }catch(err){
      console.error(err); toast('Failed to load exercise sheet: ' + err.message, 2600);
    }
  }

  // ======= EVENTS =======
  function bindEvents(){
    // Master reload (auto-load also runs on init)
    const _rmBtn = $('#reloadMasterBtn'); if(_rmBtn) _rmBtn.addEventListener('click', loadMaster);

    const _selMaster = $('#masterSelect'); if(_selMaster){ _selMaster.addEventListener('change', ()=> { $('#openMasterBtn').disabled = !_selMaster.value; }); }

    const _openMaster = $('#openMasterBtn'); if(_openMaster) _openMaster.addEventListener('click', ()=>{ 
      const sel = $('#masterSelect');
      const id = sel?.value;
      const title = sel?.options?.[sel.selectedIndex]?.textContent || 'Built-in';
      if(!id){ toast('Choose from the Built‑in list'); return; }
      loadExerciseSheet(id, title);
    });

    $('#loadCustomBtn').addEventListener('click', ()=>{
      const id = $('#customId').value.trim(); if(!id) return toast('Paste a Spreadsheet ID');
      loadExerciseSheet(id, 'Custom');
    });

    // Small local demo
    $('#demoBtn').addEventListener('click', ()=>{
      const rows = [
        {title:'Unit 1', words:['usage','united','must','animal']},
        {title:'动物 (Animals)', words:['猫','狗','老虎','大象']},
      ];
      buildExercisePicker(rows, 'Demo');
      toast('Loaded demo data');
    });

    $('#backHomeBtn').addEventListener('click', ()=> { if('speechSynthesis' in window) speechSynthesis.cancel(); show('#screen-home'); });

    $('#playBtn').addEventListener('click', ()=> speak(currentWord()));
    $('#submitBtn').addEventListener('click', submitAnswer);
    $('#tryAgainBtn').addEventListener('click', tryAgain);
    $('#skipBtn').addEventListener('click', skipWord);
    $('#showBtn').addEventListener('click', showAnswer);
    $('#stopBtn').addEventListener('click', ()=> { if('speechSynthesis' in window) speechSynthesis.cancel(); show('#screen-picker'); });
    const _backToPicker = $('#backToPicker'); if(_backToPicker) _backToPicker.addEventListener('click', ()=> { if('speechSynthesis' in window) speechSynthesis.cancel(); show('#screen-picker'); });
    const _homeRun = $('#homeBtnRun'); if(_homeRun) _homeRun.addEventListener('click', ()=> { if('speechSynthesis' in window) speechSynthesis.cancel(); show('#screen-home'); });

    $('#answerInput').addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); submitAnswer(); }
    });

    // voice selects
    function selectByName(name){ return state.voices.find(v=>v.name===decodeURIComponent(name)); }
     savePrefs(); });
     savePrefs(); });
    const _enVoice2 = $('#enVoice2'); if(_enVoice2) _enVoice2.addEventListener('change', (e)=>{ state.selected.en = state.voices.find(v=>v.name===decodeURIComponent(e.target.value)); savePrefs(); }); savePrefs(); });
    const _zhVoice2 = $('#zhVoice2'); if(_zhVoice2) _zhVoice2.addEventListener('change', (e)=>{ state.selected.zh = state.voices.find(v=>v.name===decodeURIComponent(e.target.value)); savePrefs(); }); savePrefs(); });

     $('#rate2').value=e.target.value; savePrefs(); });
     $('#pitch2').value=e.target.value; savePrefs(); });
    const _rate2 = $('#rate2'); if(_rate2) _rate2.addEventListener('input', (e)=>{ state.selected.rate = parseFloat(e.target.value); const r = $('#rate'); if(r) r.value = e.target.value; savePrefs(); }); $('#rate').value=e.target.value; savePrefs(); });
    const _pitch2 = $('#pitch2'); if(_pitch2) _pitch2.addEventListener('input', (e)=>{ state.selected.pitch = parseFloat(e.target.value); const p = $('#pitch'); if(p) p.value = e.target.value; savePrefs(); }); $('#pitch').value=e.target.value; savePrefs(); });

    
    $('#randomizeToggle').addEventListener('change', savePrefs);

    const _homeSummary = $('#homeBtnSummary'); if(_homeSummary) _homeSummary.addEventListener('click', ()=> { if('speechSynthesis' in window) speechSynthesis.cancel(); show('#screen-home'); });

    // settings modal
    const modal = $('#settingsModal');
    const _openSettingsBtn = $('#openSettingsBtn'); if(_openSettingsBtn) _openSettingsBtn.addEventListener('click', ()=> modal.showModal());
    const _revealSettingsBtn = $('#revealSettingsBtn'); if(_revealSettingsBtn) _revealSettingsBtn.addEventListener('click', ()=> modal.showModal());
    $('#openSettingsBtn').addEventListener('click', ()=> modal.showModal());

    // test buttons
    function testSpeakEn(){ speak('Hello! This is the English voice test.'); }
    function testSpeakZh(){ speak('你好！这是中文语音测试。'); }
    
    
    const _testEN2 = $('#testEN2'); if(_testEN2) _testEN2.addEventListener('click', ()=> speak('Hello! This is the English voice test.')); 
    const _testZH2 = $('#testZH2'); if(_testZH2) _testZH2.addEventListener('click', ()=> speak('你好！这是中文语音测试。')); 
  }

  // ======= INIT =======
  (function init(){
    loadPrefs();
    bindEvents();

    if(!('speechSynthesis' in window)){
      setTtsStatus('TTS unsupported'); toast('This browser does not support Speech Synthesis.');
    } else {
      setTtsStatus('TTS: loading voices…');
      window.speechSynthesis.onvoiceschanged = ()=> onVoices(window.speechSynthesis.getVoices());
      loadVoices();
      // Nudge some browsers to populate voices
      const temp = new SpeechSynthesisUtterance(''); speechSynthesis.speak(temp); speechSynthesis.cancel();
    }

    // Auto-load master on page load (silently hide if not available)
    loadMaster();
  })();
  </script>
</body>
</html>
