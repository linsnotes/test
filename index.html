<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Language Puzzle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Base Styles */
        :root {
            --primary: #1a73e8; /* Modern blue color (Google style) */
            --primary-hover: #0b5fdb; /* Darker shade for hover */
            --secondary: #e5e7eb;
            --accent: #8b5cf6;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f9fafb;
            --dark: #111827;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 0.5rem;
            --transition: all 0.3s ease;
        }

        /* Typography */
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            color: var(--text-primary);
            line-height: 1.5;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            margin-top: 0;
            color: var(--dark);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        /* Layout */
        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--secondary);
            margin-bottom: 2rem;
        }

        .app-footer {
            margin-top: auto;
            text-align: center;
            padding: 1rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--secondary);
        }
        
        .app-footer a {
            color: #6b7280; /* Gray color */
            text-decoration: none;
        }

        /* Cards and Screens */
        .screen {
            display: none;
            opacity: 0;
            transition: var(--transition);
            transform: translateY(10px);
        }

        .screen.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .card-header {
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--secondary);
            padding-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            margin: 0;
        }

        .card-body {
            margin-bottom: 1.5rem;
        }

        .card-footer {
            border-top: 1px solid var(--secondary);
            padding-top: 1rem;
            display: flex;
            justify-content: center; /* Center all buttons in card footer */
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-control {
            display: block;
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid var(--secondary);
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }

        /* Quiz ID input specific styling */
        #quizId, #userName {
            width: 100%;
            box-sizing: border-box;
            margin: 0;
            padding: 0.75rem;
        }
        
        /* Fix alignment for the quiz ID container */
        .form-group {
            padding: 0;
            margin-bottom: 1.5rem;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            font-weight: 500;
            text-align: center;
            vertical-align: middle;
            user-select: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: var(--radius);
            transition: var(--transition);
            cursor: pointer;
            border: none;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #0ca678;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Quiz Elements */
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .timer-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: var(--radius);
        }

        .timer-container i {
            color: var(--primary);
        }

        .timer-value {
            color: var(--text-primary);
        }

        .question-counter {
            font-weight: 500;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: var(--radius);
        }

        .quiz-instructions {
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background-color: rgba(26, 115, 232, 0.1);
            border-left: 4px solid var(--primary);
            border-radius: 0 var(--radius) var(--radius) 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Word Containers */
        .drop-zone {
            min-height: 80px;
            border: 2px dashed #d1d5db;
            padding: 1rem;
            margin-bottom: 1.5rem;
            background: #f9fafb;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .drop-zone:hover {
            border-color: var(--primary);
        }

        .drop-zone-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .word-box {
            display: inline-block;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            cursor: move;
            user-select: none;
            transition: var(--transition);
            border: 1px solid #e5e7eb;
        }

        .word-box:hover {
            background: #f3f4f6;
            transform: translateY(-2px);
        }

        .word-box.dragging {
            opacity: 0.6;
            background: rgba(26, 115, 232, 0.1);
            border-color: var(--primary);
        }

        /* Results Screen */
        .result-summary {
            padding: 1.5rem;
            background-color: #f3f4f6;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
        }

        .result-stat {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .result-stat i {
            margin-right: 0.75rem;
            color: var(--primary);
            width: 24px;
            text-align: center;
        }

        .results-table-container {
            overflow-x: auto;
            margin-bottom: 1.5rem;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .results-table th,
        .results-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--secondary);
        }

        .results-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .results-table tr:hover td {
            background-color: #f3f4f6;
        }

        /* Divider and alternative option styling */
        .divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .divider::before,
        .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid var(--secondary);
        }

        .divider::before {
            margin-right: 1rem;
        }

        .divider::after {
            margin-left: 1rem;
        }

        /* Progress bar for quiz */
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: var(--secondary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s ease;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .card {
                padding: 1.5rem;
            }

            .btn {
                padding: 0.625rem 1.25rem;
            }

            .quiz-header {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }

            .timer-container, .question-counter {
                width: 100%;
                box-sizing: border-box;
                margin: 0.25rem 0;
                padding: 0.5rem;
                font-size: 0.875rem;
            }

            .results-table th,
            .results-table td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .app-header h1 {
                margin-bottom: 0.75rem; /* Smaller gap below h1 on mobile */
            }
            
            .card-footer {
                justify-content: center;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .word-box {
                padding: 0.375rem 0.75rem;
                margin: 0.125rem;
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1><i class="fas fa-puzzle-piece"></i> Language Puzzle</h1>
        </header>

        <!-- Landing Screen -->
        <div id="landingScreen" class="screen active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Welcome to Language Puzzle</h2>
                </div>
                <div class="card-body">
                    <p>Test your language skills by arranging words in the correct order.</p>
                    <div class="form-group">
                        <button onclick="startBuiltInQuiz()" class="btn btn-primary btn-lg" style="width: 100%;">
                            <i class="fas fa-play"></i> Start Built-in Quiz
                        </button>
                    </div>
                    
                    <div class="divider">OR</div>
                    
                    <div class="form-group">
                        <label for="quizId" class="form-label">Have a custom quiz?</label>
                        <p class="form-text" style="margin-top: 0.25rem; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                            <i class="fas fa-info-circle"></i> Custom Quiz ID is provided by your teacher
                        </p>
                        <input type="text" id="quizId" placeholder="Enter Quiz ID" class="form-control">
                    </div>
                </div>
                <div class="card-footer">
                    <button onclick="startCustomQuiz()" class="btn btn-secondary">
                        <i class="fas fa-file-import"></i> Start Custom Quiz
                    </button>
                </div>
            </div>
        </div>

        <!-- Name Screen -->
        <div id="nameScreen" class="screen">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Let's Get Started</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="userName" class="form-label">Enter Your Name</label>
                        <input type="text" id="userName" required class="form-control" placeholder="Your Name">
                    </div>
                </div>
                <div class="card-footer">
                    <button onclick="startQuiz()" class="btn btn-primary">
                        <i class="fas fa-arrow-right"></i> Start Quiz
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="screen">
            <div class="card">
                <div class="quiz-header">
                    <div class="timer-container">
                        <i class="fas fa-clock"></i>
                        Time: <span id="timer" class="timer-value">0</span>s
                    </div>
                    <div class="question-counter" id="questionNumber"></div>
                </div>
                <div id="progressContainer" class="progress-container">
                    <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                </div>
                <div class="quiz-instructions">
                    <i class="fas fa-info-circle"></i> Drag words or double-click them to move between boxes
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="drop-zone-label">Available Words:</label>
                        <div id="wordContainer" class="drop-zone" ondrop="handleSourceDrop(event)" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="form-group">
                        <label class="drop-zone-label">Your Answer:</label>
                        <div class="drop-zone" id="answerZone" ondrop="handleAnswerDrop(event)" ondragover="allowDrop(event)"></div>
                    </div>
                </div>
                <div class="card-footer">
                    <button onclick="checkAnswer()" class="btn btn-primary">
                        <i class="fas fa-check-circle"></i> Confirm Answer
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="screen">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Quiz Results</h2>
                </div>
                <div class="card-body">
                    <div class="result-summary" id="resultSummary">
                        <!-- Results summary will be inserted here -->
                    </div>
                    
                    <div class="results-table-container">
                        <table id="resultsTable" class="results-table">
                            <!-- Results table will be inserted here -->
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <button onclick="screenshotResults()" class="btn btn-secondary">
                        <i class="fas fa-camera"></i> Screenshot Results
                    </button>
                    <button onclick="reviewQuestions()" class="btn btn-primary">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            <div id="visitor-counter">
               Welcome! You're visitor #<span id="pageviews">Loading...</span> 
            </div>
            <p><a href="https://linsnotes.com">linsnotes.com</a></p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script data-goatcounter="https://linsnotes.goatcounter.com/count" async src="https://gc.zgo.at/count.js"></script>

    <script>
        let currentQuestion = 0;
        let quizData = [];
        let userData = { name: '', startTime: 0, attempts: [], totalPoints: 0 };
        let timerInterval;
        let timerPaused = false;
        let elapsedTime = 0;
        let pausedAt = 0;
        const BUILT_IN_SHEET_ID = '1jsmk781Fob4qrAd61DrBDyJQQ0beEFF92yA3uWr7UII';
        let draggedElement = null;
        let questionAttempts = {};

        // Drag & Drop Functions
        function allowDrop(ev) { ev.preventDefault(); }
        function dragStart(ev) {
            draggedElement = ev.target;
            draggedElement.classList.add('dragging');
            ev.dataTransfer.effectAllowed = 'move';
        }
        function dragEnd() {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }
        }
        function handleSourceDrop(ev) {
            ev.preventDefault();
            if (draggedElement && draggedElement.parentElement.id === 'answerZone') {
                const afterElement = getDragAfterElement(ev.currentTarget, ev.clientX);
                if (afterElement) ev.currentTarget.insertBefore(draggedElement, afterElement);
                else ev.currentTarget.appendChild(draggedElement);
            }
        }
        function handleAnswerDrop(ev) {
            ev.preventDefault();
            if (draggedElement) {
                const afterElement = getDragAfterElement(ev.currentTarget, ev.clientX);
                const container = ev.currentTarget;
                if (afterElement) container.insertBefore(draggedElement, afterElement);
                else container.appendChild(draggedElement);
            }
        }
        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.word-box:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                return (offset < 0 && offset > closest.offset) ? 
                    { offset: offset, element: child } : closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Double-click Functions
        function setupDoubleClickHandlers() {
            // Use event delegation to handle double-clicks
            document.getElementById('wordContainer').addEventListener('dblclick', function(e) {
                if (e.target.classList.contains('word-box')) {
                    document.getElementById('answerZone').appendChild(e.target);
                }
            });
            
            document.getElementById('answerZone').addEventListener('dblclick', function(e) {
                if (e.target.classList.contains('word-box')) {
                    document.getElementById('wordContainer').appendChild(e.target);
                }
            });
        }

        // Core Quiz Functions
        async function loadSheetData(sheetId) {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
                const response = await fetch(url);
                const csv = await response.text();
                const workbook = XLSX.read(csv, {type: 'string'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                return rows.slice(1).map(row => row[0]); // Skip header row
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'Error loading quiz data. Please check Quiz ID',
                    icon: 'error',
                    confirmButtonColor: '#1a73e8'
                });
                return null;
            }
        }

        function startBuiltInQuiz() { startQuizFlow(BUILT_IN_SHEET_ID); }
        async function startCustomQuiz() {
            const sheetId = document.getElementById('quizId').value;
            if (!sheetId) return Swal.fire({
                title: 'Missing Input',
                text: 'Please enter Quiz ID',
                icon: 'warning',
                confirmButtonColor: '#1a73e8'
            });
            startQuizFlow(sheetId);
        }

        async function startQuizFlow(sheetId) {
            // Show loading indicator
            Swal.fire({
                title: 'Loading Quiz',
                text: 'Please wait...',
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const data = await loadSheetData(sheetId);
            Swal.close();
            
            if (!data) return;
            
            quizData = data.map(question => ({
                parts: question.split('#').filter(p => p.trim()),
                correct: question.replace(/#/g, ''),
                shuffled: null
            }));
            
            questionAttempts = {};
            quizData.forEach((_, idx) => {
                questionAttempts[idx] = { attempts: 0, correct: false };
            });
            
            showScreen('nameScreen');
        }

        function startQuiz() {
            userData.name = document.getElementById('userName').value.trim();
            if (!userData.name) return Swal.fire({
                title: 'Missing Input',
                text: 'Please enter your name',
                icon: 'warning',
                confirmButtonColor: '#1a73e8'
            });
            
            // Set up double-click handlers
            setupDoubleClickHandlers();
            
            showScreen('quizScreen');
            loadQuestion();
            startTimer();
        }

        function loadQuestion() {
            const question = quizData[currentQuestion];
            if (!question.shuffled) {
                question.shuffled = shuffle([...question.parts]);
            }
            
            // Update progress bar
            const progressPercentage = (currentQuestion / quizData.length) * 100;
            document.getElementById('progressBar').style.width = `${progressPercentage}%`;
            
            document.getElementById('questionNumber').textContent = 
                `Question ${currentQuestion + 1} of ${quizData.length}`;
            
            const wordContainer = document.getElementById('wordContainer');
            wordContainer.innerHTML = question.shuffled.map(word => 
                `<div class="word-box" draggable="true" 
                    ondragstart="dragStart(event)" 
                    ondragend="dragEnd(event)">${word}</div>`
            ).join('');
            
            document.getElementById('answerZone').innerHTML = '';
        }

        function startTimer() {
            if (pausedAt > 0) {
                // Resume timer
                elapsedTime = pausedAt;
                pausedAt = 0;
            } else {
                // Start new timer
                elapsedTime = 0;
                userData.startTime = Date.now();
            }
            
            timerPaused = false;
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (!timerPaused) {
                    elapsedTime = Math.floor((Date.now() - userData.startTime) / 1000);
                    document.getElementById('timer').textContent = elapsedTime;
                }
            }, 1000);
        }

        function pauseTimer() {
            timerPaused = true;
            pausedAt = elapsedTime;
        }

        function resumeTimer() {
            timerPaused = false;
            userData.startTime = Date.now() - (pausedAt * 1000);
        }

        function checkAnswer() {
            const timeSpent = elapsedTime;
            const userAnswer = [...document.querySelectorAll('#answerZone .word-box')]
                .map(node => node.textContent).join('');
            
            const isCorrect = userAnswer === quizData[currentQuestion].correct;
            questionAttempts[currentQuestion].attempts++;
            
            if (isCorrect) {
                questionAttempts[currentQuestion].correct = true;
                const points = calculatePoints(timeSpent);
                
                // Only add to userData.attempts if this is the first time it's correct
                if (!userData.attempts.some(a => a.question === currentQuestion + 1)) {
                    userData.attempts.push({
                        question: currentQuestion + 1,
                        time: timeSpent,
                        points,
                        userAnswer,
                        correctAnswer: quizData[currentQuestion].correct,
                        attempts: questionAttempts[currentQuestion].attempts
                    });
                } else {
                    // Update the existing attempt with the new data
                    const idx = userData.attempts.findIndex(a => a.question === currentQuestion + 1);
                    if (idx !== -1) {
                        userData.attempts[idx] = {
                            question: currentQuestion + 1,
                            time: timeSpent,
                            points,
                            userAnswer,
                            correctAnswer: quizData[currentQuestion].correct,
                            attempts: questionAttempts[currentQuestion].attempts
                        };
                    }
                }
                
                Swal.fire({
                    title: 'Correct!',
                    text: `(+${points} points)`,
                    icon: 'success',
                    confirmButtonColor: '#1a73e8',
                    timer: 1500
                });
                if (currentQuestion < quizData.length - 1) {
                    currentQuestion++;
                    pausedAt = 0;
                    elapsedTime = 0;
                    loadQuestion();
                    startTimer();
                } else {
                    showResults();
                }
            } else {
                pauseTimer();
                Swal.fire({
                    title: 'Wrong!',
                    text: 'Would you like to try again?',
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, try again',
                    cancelButtonText: 'No, next question',
                    confirmButtonColor: '#1a73e8',
                    cancelButtonColor: '#ef4444'
                }).then((result) => {
                    if (result.isConfirmed) {
                        resumeTimer();
                        // Do not reset the question or timer
                    } else {
                        // User doesn't want to retry, mark as incorrect attempt
                        userData.attempts.push({
                            question: currentQuestion + 1,
                            time: timeSpent,
                            points: 0,
                            userAnswer,
                            correctAnswer: quizData[currentQuestion].correct,
                            attempts: questionAttempts[currentQuestion].attempts
                        });
                        
                        Swal.fire({
                            title: 'Answer',
                            html: `<p style="text-align: left; margin-bottom: 8px;">Correct answer:</p> 
                                  <p style="text-align: left; font-weight: bold;">${quizData[currentQuestion].correct}</p>`,
                            icon: 'info',
                            confirmButtonColor: '#1a73e8'
                        }).then(() => {
                            currentQuestion++;
                            
                            if (currentQuestion < quizData.length) {
                                pausedAt = 0;
                                elapsedTime = 0;
                                loadQuestion();
                                startTimer();
                            } else {
                                showResults();
                            }
                        });
                    }
                });
            }
        }

        // Utility functions
        function calculatePoints(seconds) {
            // const brackets = [[5,10],[10,9],[15,8],[20,7],[25,6],[30,5],[35,4],[40,3],[60,2],[Infinity,1]];
            const brackets = [[10,10],[20,9],[30,8],[40,7],[50,6],[60,5],[70,4],[80,3],[90,2],[Infinity,1]];
            return brackets.find(([max]) => seconds <= max)[1];
        }

        function showResults() {
            clearInterval(timerInterval);
            showScreen('resultsScreen');
            userData.totalPoints = userData.attempts.reduce((sum, a) => sum + a.points, 0);
            
            // Get completion timestamp
            const completionDate = new Date();
            const day = completionDate.getDate().toString().padStart(2, '0');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const month = monthNames[completionDate.getMonth()];
            const year = completionDate.getFullYear();
            const hours = completionDate.getHours().toString().padStart(2, '0');
            const minutes = completionDate.getMinutes().toString().padStart(2, '0');
            const seconds = completionDate.getSeconds().toString().padStart(2, '0');
            const completionTimestamp = `${day} ${month} ${year}, ${hours}:${minutes}:${seconds}`;
            
            // Update the resultSummary with improved styling
            document.getElementById('resultSummary').innerHTML = `
                <div class="result-stat">
                    <i class="fas fa-user"></i>
                    <span><strong>Name:</strong> ${userData.name}</span>
                </div>
                <div class="result-stat">
                    <i class="fas fa-calendar-check"></i>
                    <span><strong>Completed:</strong> ${completionTimestamp}</span>
                </div>
                <div class="result-stat">
                    <i class="fas fa-trophy"></i>
                    <span><strong>Total Score:</strong> ${userData.totalPoints} points</span>
                </div>
                <div class="result-stat">
                    <i class="fas fa-check-circle"></i>
                    <span><strong>Correct Answers:</strong> ${userData.attempts.filter(a => a.points > 0).length}/${quizData.length}</span>
                </div>
            `;
            
            const table = document.getElementById('resultsTable');
            table.innerHTML = `
                <tr>
                    <th>Question</th>
                    <th>Time</th>
                    <th>Points</th>
                    <th>Attempts</th>
                    <th>Your Answer</th>
                    <th>Correct Answer</th>
                </tr>
                ${userData.attempts.map(a => `
                    <tr>
                        <td>${a.question}</td>
                        <td>${a.time}s</td>
                        <td>${a.points}</td>
                        <td>${a.attempts}</td>
                        <td>${a.userAnswer}</td>
                        <td>${a.correctAnswer}</td>
                    </tr>
                `).join('')}
            `;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            // Show/hide header and footer based on screen
            if (screenId === 'quizScreen') {
                document.querySelector('.app-header').style.display = 'none';
                document.querySelector('.app-footer').style.display = 'none';
            } else {
                document.querySelector('.app-header').style.display = 'block';
                document.querySelector('.app-footer').style.display = 'block';
            }
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function screenshotResults() {
            // Show loading indicator
            Swal.fire({
                title: 'Generating Screenshot',
                text: 'Please wait...',
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });
            
            html2canvas(document.querySelector('#resultsScreen')).then(canvas => {
                Swal.close();
                const link = document.createElement('a');
                link.download = 'quiz-results.png';
                link.href = canvas.toDataURL();
                link.click();
                
                Swal.fire({
                    title: 'Success!',
                    text: 'Your results have been saved as an image',
                    icon: 'success',
                    confirmButtonColor: '#1a73e8',
                });
            });
        }

        function reviewQuestions() {
            Swal.fire({
                title: 'Try Again?',
                text: 'You are about to restart the quiz. Your current progress will be reset.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, restart',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#1a73e8',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    currentQuestion = 0;
                    quizData.forEach(q => q.shuffled = null);
                    userData.attempts = [];
                    questionAttempts = {};
                    quizData.forEach((_, idx) => {
                        questionAttempts[idx] = { attempts: 0, correct: false };
                    });
                    pausedAt = 0;
                    elapsedTime = 0;
                    showScreen('quizScreen');
                    loadQuestion();
                    startTimer();
                }
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            const pv = document.getElementById('pageviews');

            if (pv !== null) {
              const uri = location.pathname.replace(/\/$/, '');
              const url = `https://linsnotes.goatcounter.com/counter/${encodeURIComponent(uri)}.json`;

              fetch(url)
                .then((response) => response.json())
                .then((data) => {
                  const count = data.count.replace(/\s/g, '');
                  pv.innerText = new Intl.NumberFormat().format(count);
                })
                .catch((error) => {
                  pv.innerText = '1';
                });
            }
          });
    </script>
</body>
</html>
