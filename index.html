<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Language Shooter</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Removed SortableJS CSS -->
    <style>
        /* Base Styles (Adapted from provided CSS) */
        :root {
            --primary: #1a73e8; /* Modern blue color (Google style) */
            --primary-hover: #0b5fdb; /* Darker shade for hover */
            --secondary: #e5e7eb;
            --accent: #8b5cf6; /* Purple accent */
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --success: #10b981; /* Green */
            --warning: #f59e0b; /* Yellow */
            --danger: #ef4444; /* Red */
            --light: #f9fafb;
            --dark: #111827;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 0.5rem;
            --transition: all 0.3s ease;

            /* Font for targets/shooter */
             --word-box-font-family: KaiTi, 'Kaiti SC', DFKai-SB, BiauKai, 'Microsoft YaHei', 'SimHei', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
             --word-box-font-size: 1.6rem; /* Slightly larger for game elements */
        }

        /* Rotating icon animation */
        .rotate-icon { display: inline-block; animation: spin 3s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Text fill effect */
        .fill-text { display: inline-block; background: linear-gradient(90deg, var(--primary), var(--accent)); background-size: 200% 100%; -webkit-background-clip: text; color: transparent; animation: fillText 5s ease infinite; }
        @keyframes fillText { from { background-position: -100% 0; } to { background-position: 0 0; } }

        /* Typography */
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 0; background-color: #f3f4f6; color: var(--text-primary); line-height: 1.5; }
        h1, h2, h3, h4, h5, h6 { font-weight: 600; margin-top: 0; color: var(--dark); }
        h1 { font-size: 2rem; margin-bottom: 1.5rem; }
        h2 { font-size: 1.5rem; margin-bottom: 1rem; }

        /* Layout */
        .app-container { max-width: 1000px; margin: 0 auto; padding: 1rem; min-height: 100vh; display: flex; flex-direction: column; }
        .app-header { text-align: center; padding: 1rem 0; border-bottom: 1px solid var(--secondary); margin-bottom: 2rem; }
        .app-footer { margin-top: auto; text-align: center; padding: 1rem 0; font-size: 0.875rem; color: var(--text-secondary); border-top: 1px solid var(--secondary); }
        .app-footer a { color: #6b7280; text-decoration: none; }

        /* Cards and Screens */
        .screen { display: none; opacity: 0; transition: var(--transition); transform: translateY(10px); }
        .screen.active { display: block; opacity: 1; transform: translateY(0); }
        .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 2rem; margin-bottom: 1.5rem; transition: var(--transition); }
        .card-header { margin-bottom: 1.5rem; border-bottom: 1px solid var(--secondary); padding-bottom: 1rem; }
        .card-title { font-size: 1.25rem; margin: 0; }
        .card-body { margin-bottom: 1.5rem; }
        .card-footer { border-top: 1px solid var(--secondary); padding-top: 1rem; display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; }

        /* Form Elements */
        .form-group { margin-bottom: 1.5rem; }
        .form-control { display: block; width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid var(--secondary); border-radius: var(--radius); transition: var(--transition); box-sizing: border-box; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2); }
        #quizId, #userName { width: 100%; margin: 0; padding: 0.75rem; }
        .center-button { text-align: center; }

        /* Buttons */
        .btn { display: inline-block; font-weight: 500; text-align: center; vertical-align: middle; user-select: none; padding: 0.75rem 1.5rem; font-size: 1rem; line-height: 1.5; border-radius: var(--radius); transition: var(--transition); cursor: pointer; border: none; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary); color: var(--text-primary); }
        .btn-secondary:hover { background-color: #d1d5db; }
        /* Add other button styles if needed (success, danger, etc.) */

        /* Quiz Screen Specific Styles */
        #quizScreen { position: relative; overflow: hidden; /* Contain absolute elements */ min-height: 70vh; /* Ensure space for elements */ background: linear-gradient(180deg, #e0f7fa 0%, #b3e5fc 100%); /* Light blue gradient bg */ }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; padding: 0.5rem; background: rgba(255, 255, 255, 0.7); border-radius: var(--radius); }
        .timer-container, .quiz-title-display, .question-counter { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--text-secondary); padding: 0.5rem 1rem; background: var(--light); border-radius: var(--radius); }
        .timer-container i { color: var(--primary); }
        .timer-value { color: var(--text-primary); }
        .quiz-instructions { margin: 0.5rem 0 1rem 0; padding: 0.75rem; background-color: rgba(26, 115, 232, 0.1); border-left: 4px solid var(--primary); border-radius: 0 var(--radius) var(--radius) 0; font-size: 0.875rem; color: var(--text-secondary); }
        .progress-container { width: 100%; height: 8px; background-color: var(--secondary); border-radius: 4px; overflow: hidden; margin-bottom: 1rem; }
        .progress-bar { height: 100%; background-color: var(--primary); transition: width 0.3s ease; }

        #gameArea {
            position: relative; /* Crucial for absolute positioning of targets */
            width: 100%;
            height: 65vh; /* Adjust height as needed */
            margin-top: 1rem;
            border: 2px dashed var(--secondary);
            border-radius: var(--radius);
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23d1d5db" fill-opacity="0.1" d="M10 10 H90 V90 H10Z M0 0 H100 V100 H0Z" /></svg>'); /* Subtle background pattern */
            overflow: hidden; /* Hide targets that might randomly go outside */
        }

        #shooter {
            position: absolute;
            bottom: 10px;
            /* Initially centered using left:50% & translate; will be re-positioned in startQuiz() */
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            background-color: var(--dark);
            color: white;
            border-radius: var(--radius);
            font-family: var(--word-box-font-family);
            font-size: var(--word-box-font-size);
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 10;
            border-top: 3px solid var(--primary);
        }

        .target {
            position: absolute; /* Positioned within gameArea */
            padding: 0.6rem 1.2rem;
            background-color: var(--accent);
            color: white;
            border-radius: 50px; /* Pill shape */
            font-family: var(--word-box-font-family);
            font-size: calc(var(--word-box-font-size) * 0.9); /* Slightly smaller than shooter */
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 5;
            user-select: none; /* Prevent text selection */
        }

        .target:hover {
            transform: scale(1.1);
            background-color: var(--primary-hover);
        }

        /* Target Animations */
        @keyframes targetHit {
            0% { transform: scale(1); opacity: 1; background-color: var(--success); }
            100% { transform: scale(1.5); opacity: 0; background-color: var(--success); }
        }
        .target-hit {
            animation: targetHit 0.4s ease-out forwards;
            pointer-events: none; /* Prevent clicking during animation */
        }

        @keyframes targetMiss { /* Simple shake */
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }
        .target-miss {
            animation: targetMiss 0.3s linear;
            background-color: var(--danger); /* Flash red */
        }

        #bullet {
            position: absolute;
            width: 10px;
            height: 20px;
            background-color: var(--warning); /* Yellow bullet */
            border-radius: 50% 50% 0 0;
            box-shadow: 0 0 5px var(--warning);
            z-index: 9;
            transition: top 0.1s linear, left 0.1s linear; /* Smooth movement */
            pointer-events: none; /* Don't block clicks */
            display: none; /* Hidden initially */
        }


        /* Results Screen (Mostly reused styles) */
        .result-summary { padding: 1.5rem; background-color: #f3f4f6; border-radius: var(--radius); margin-bottom: 1.5rem; }
        .result-stat { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .result-stat i { margin-right: 0.75rem; color: var(--primary); width: 24px; text-align: center; }
        .results-table-container { overflow-x: auto; margin-bottom: 1.5rem; }
        .results-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        .results-table th, .results-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--secondary); }
        .results-table th { background-color: #f9fafb; font-weight: 600; color: var(--text-secondary); }
        .results-table tr:hover td { background-color: #f3f4f6; }
        .results-table td.correct { color: var(--success); }
        .results-table td.incorrect { color: var(--danger); } /* Style incorrect answers if needed */

        /* Divider */
        .divider { display: flex; align-items: center; margin: 1.5rem 0; color: var(--text-secondary); font-size: 0.875rem; }
        .divider::before, .divider::after { content: ""; flex: 1; border-bottom: 1px solid var(--secondary); }
        .divider::before { margin-right: 1rem; }
        .divider::after { margin-left: 1rem; }

        /* Google Sheet Dropdown Styling */
        #quizSelect { /* Style reused */ width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid var(--secondary); border-radius: var(--radius); transition: var(--transition); background-color: white; color: var(--text-primary); appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b7280'%3E%3Cpath d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem top 50%; background-size: 1.25rem; }
        #quizSelect:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2); }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .card { padding: 1.5rem; }
            .quiz-header { flex-direction: column; align-items: flex-start; width: 100%; }
            .timer-container, .quiz-title-display, .question-counter { width: 100%; box-sizing: border-box; margin: 0.25rem 0; padding: 0.5rem; font-size: 0.875rem; justify-content: center; }
            #gameArea { height: 55vh; }
            #shooter { padding: 0.8rem 1.5rem; font-size: calc(var(--word-box-font-size) * 0.9); }
            .target { padding: 0.5rem 1rem; font-size: calc(var(--word-box-font-size) * 0.8); }
            .results-table th, .results-table td { padding: 0.5rem; font-size: 0.75rem; }
        }
        @media (max-width: 480px) {
            h1 { font-size: 1.8rem; }
            .card-footer { justify-content: center; }
            .btn { width: 100%; margin-bottom: 0.5rem; }
            #gameArea { height: 50vh; }
            #shooter { padding: 0.6rem 1.2rem; font-size: calc(var(--word-box-font-size) * 0.8); }
            .target { padding: 0.4rem 0.8rem; font-size: calc(var(--word-box-font-size) * 0.7); }
            .quiz-title-display { font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
             <h1><i class="fas fa-crosshairs rotate-icon"></i>
                <span class="fill-text">Language Shooter</span>
             </h1>
        </header>

        <!-- Landing Screen -->
        <div id="landingScreen" class="screen active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Welcome to Language Shooter</h2>
                    <p>Take aim and match the words!</p>
                </div>
                <div class="card-body">
                    <!-- Quiz Selection -->
                    <div class="form-group">
                        <label for="quizSelect" class="form-label">Built-in Quiz:</label>
                        <select id="quizSelect" class="form-control"></select> <!-- Options populated by JS -->
                    </div>
                    <div class="center-button">
                        <button onclick="startSelectedQuiz()" class="btn btn-primary" disabled> <!-- Initially disabled -->
                            <i class="fas fa-play-circle"></i> Start Built-in Quiz
                        </button>
                    </div>
                    <div class="divider">OR</div>

                    <div class="form-group">
                        <label for="quizId" class="form-label">Have a custom quiz?</label>
                        <p class="form-text" style="margin-top: 0.25rem; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                            <i class="fas fa-info-circle"></i> Enter the Google Sheet ID for your quiz.
                        </p>
                        <input type="text" id="quizId" placeholder="Enter Google Sheet ID" class="form-control">
                    </div>
                </div>
                 <div class="center-button">
                    <button onclick="startCustomQuiz()" class="btn btn-secondary">
                        <i class="fas fa-file-import"></i> Start Custom Quiz
                    </button>
                </div>
            </div>
        </div>

        <!-- Name Screen -->
        <div id="nameScreen" class="screen">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Ready Player?</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="userName" class="form-label">Enter Your Name</label>
                        <input type="text" id="userName" required class="form-control" placeholder="Your Name">
                    </div>
                </div>
                <div class="card-footer">
                    <button onclick="startQuiz()" class="btn btn-primary">
                        <i class="fas fa-gamepad"></i> Start Game
                    </button>
                    <button onclick="goHome()" class="btn btn-secondary">
                        <i class="fas fa-home"></i> Back to Home
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="screen">
             <!-- Header elements -->
            <div class="quiz-header">
                <div class="timer-container">
                    <i class="fas fa-clock"></i> Time: <span id="timer" class="timer-value">0</span>s
                </div>
                 <div id="quizTitleDisplay" class="quiz-title-display">
                     <!-- Quiz title will be shown here -->
                 </div>
                <div class="question-counter" id="questionNumber"></div>
            </div>
            <div id="progressContainer" class="progress-container">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
             <div class="quiz-instructions">
                <i class="fas fa-info-circle"></i> Use the arrow keys to move and SPACE to fire!
            </div>

            <!-- Game Area -->
            <div id="gameArea">
                <!-- Targets will be added here by JS -->
            </div>

            <!-- Shooter -->
            <div id="shooter">
                <!-- Current Column A word here -->
            </div>

             <!-- Bullet Element (initially hidden) -->
            <div id="bullet"></div>

            <!-- No buttons needed here anymore, interaction is via keyboard & game loop -->
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="screen">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Game Over - Results</h2>
                </div>
                <div class="card-body">
                    <div class="result-summary" id="resultSummary">
                        <!-- Results summary will be inserted here -->
                    </div>

                    <div class="results-table-container">
                        <table id="resultsTable" class="results-table">
                            <!-- Results table will be inserted here -->
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <button onclick="screenshotResults()" class="btn btn-secondary">
                        <i class="fas fa-camera"></i> Screenshot Results
                    </button>
                    <button onclick="reviewQuestions()" class="btn btn-primary">
                        <i class="fas fa-redo"></i> Play Again
                    </button>
                     <button onclick="goHome()" class="btn btn-secondary">
                        <i class="fas fa-home"></i> Back to Home
                    </button>
                </div>
            </div>
        </div>

        <footer class="app-footer">
             <!-- Optional: Visitor counter -->
            <p><a href="https://linsnotes.com">Created based on linsnotes.com example</a></p>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Removed SortableJS script -->

    <script>
        let currentQuestion = 0;
        let quizData = []; // Array of { colA: "word1", colB: "match1" }
        let allTargets = []; // Array of all unique Column B words
        let userData = { name: '', startTime: 0, attempts: [], totalPoints: 0 }; // Attempts: { question: num, time: sec, points: num, attempts: num }
        let timerInterval;
        let timerPaused = false;
        let elapsedTime = 0;
        let questionStartTime = 0; // Track start time for each question
        let questionAttempts = {}; // Tracks attempts per question index { index: count }

        // New variables for shooter, bullet and game loop
        let bulletActive = false;
        let bulletX = 0, bulletY = 0;
        const bulletSpeed = 5; // pixels per frame (adjust as needed)
        let gameLoopId = null;

        // !!! IMPORTANT: REPLACE WITH YOUR QUIZ LIST SHEET ID !!!
        const QUIZ_LIST_SHEET_ID = '1b_yzMM-qy_g9Sa-kO5mPtAL67neZdaIW_QIQcfFHaNg'; // e.g., '1jsmk781Fob4qrAd61DrBDyJQQ0beEFF92yA3uWr7UII'

        let quizTitlesAndIds = [];
        let currentSheetId = ''; // Track the current sheet ID
        let currentCorrectAnswer = ''; // Holds the correct ColB for the current question
        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
        const textSecondary = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();

        // DOM Elements Cache
        const DOMElements = {
            landingScreen: document.getElementById('landingScreen'),
            nameScreen: document.getElementById('nameScreen'),
            quizScreen: document.getElementById('quizScreen'),
            resultsScreen: document.getElementById('resultsScreen'),
            quizSelect: document.getElementById('quizSelect'),
            quizIdInput: document.getElementById('quizId'),
            userNameInput: document.getElementById('userName'),
            timerDisplay: document.getElementById('timer'),
            quizTitleDisplay: document.getElementById('quizTitleDisplay'),
            questionNumberDisplay: document.getElementById('questionNumber'),
            progressBar: document.getElementById('progressBar'),
            gameArea: document.getElementById('gameArea'),
            shooter: document.getElementById('shooter'),
            bullet: document.getElementById('bullet'),
            resultSummary: document.getElementById('resultSummary'),
            resultsTable: document.getElementById('resultsTable'),
            startBuiltInButton: document.querySelector('button[onclick="startSelectedQuiz()"]'),
            appHeader: document.querySelector('.app-header'),
            appFooter: document.querySelector('.app-footer')
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadQuizTitlesAndIds();
        });

        // Screen Management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const targetScreen = DOMElements[screenId]; // Use cached element
            if (targetScreen) {
                targetScreen.classList.add('active');
            } else {
                console.error(`Screen with ID ${screenId} not found.`);
                DOMElements.landingScreen.classList.add('active'); // Fallback
            }
            // Hide header/footer only on quiz screen for focus
            const showHeaderFooter = (screenId !== 'quizScreen');
            DOMElements.appHeader.style.display = showHeaderFooter ? 'block' : 'none';
            DOMElements.appFooter.style.display = showHeaderFooter ? 'block' : 'none';
        }

        function goHome() {
            // Reset state variables
            resetQuizState();
            // Reset UI elements on landing page
            DOMElements.quizIdInput.value = '';
            DOMElements.quizSelect.selectedIndex = 0; // Reset dropdown to placeholder
            DOMElements.startBuiltInButton.disabled = true; // Disable button
             // Ensure header/footer are visible
             DOMElements.appHeader.style.display = 'block';
             DOMElements.appFooter.style.display = 'block';

            showScreen('landingScreen');
        }

        // Data Loading
        async function loadSheetData(sheetId) {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`; // Added gid=0 for first sheet
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csv = await response.text();
                const workbook = XLSX.read(csv, { type: 'string' });
                const sheetName = workbook.SheetNames[0];
                if (!sheetName) throw new Error('No sheet found in the workbook.');

                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });

                // Assume Title is in A1 (optional)
                window.quizTitle = rows?.[0]?.[0]?.trim() || `Quiz (${sheetId.substring(0, 6)}...)`;

                // Process data rows (starting from row 2, index 1)
                const data = rows.slice(1)
                    .map(row => ({
                        colA: row[0] ? String(row[0]).trim() : null,
                        colB: row[1] ? String(row[1]).trim() : null
                    }))
                    .filter(item => item.colA && item.colB);

                if (data.length === 0) {
                    console.warn('Sheet has no valid data rows (needs content in columns A and B).');
                    return null;
                }

                 // Extract all unique Column B values for targets
                allTargets = [...new Set(data.map(item => item.colB))];

                return data;

            } catch (error) {
                console.error('Error loading sheet data:', error);
                Swal.fire({
                    title: 'Error Loading Quiz',
                    text: `Could not load quiz data. Check Sheet ID [${sheetId}] or network. Is sheet published & shared? Details: ${error.message}`,
                    icon: 'error',
                    confirmButtonColor: primaryColor
                });
                return null;
            }
        }

        async function loadQuizTitlesAndIds() {
             if (QUIZ_LIST_SHEET_ID === 'YOUR_QUIZ_LIST_SHEET_ID_HERE') {
                console.warn("Quiz List Sheet ID not set. Disabling built-in quiz option.");
                DOMElements.quizSelect.innerHTML = '<option value="" disabled selected>Built-in Quizzes Unavailable</option>';
                DOMElements.quizSelect.disabled = true;
                DOMElements.startBuiltInButton.disabled = true;
                return;
             }

            try {
                const url = `https://docs.google.com/spreadsheets/d/${QUIZ_LIST_SHEET_ID}/export?format=csv&gid=0`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csv = await response.text();
                const workbook = XLSX.read(csv, { type: 'string' });
                const sheetName = workbook.SheetNames[0];
                if (!sheetName) throw new Error('No sheet found for quiz list.');
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });

                quizTitlesAndIds = rows.slice(1)
                    .map(row => ({ title: row[0]?.trim(), id: row[1]?.trim() }))
                    .filter(quiz => quiz.title && quiz.id);

                populateQuizSelect();

            } catch (error) {
                console.error('Error loading quiz titles:', error);
                 Swal.fire({
                    title: 'Error Loading Quiz List',
                    text: `Could not load built-in quizzes. Check console for details. Details: ${error.message}`,
                    icon: 'error',
                    confirmButtonColor: primaryColor
                });
                DOMElements.quizSelect.innerHTML = '<option value="" disabled selected>Error Loading Quizzes</option>';
                DOMElements.quizSelect.disabled = true;
                DOMElements.startBuiltInButton.disabled = true;
            }
        }

        function populateQuizSelect() {
            const select = DOMElements.quizSelect;
            select.innerHTML = '';

            if (quizTitlesAndIds.length === 0) {
                select.innerHTML = '<option value="" disabled selected>No Built-in Quizzes Found</option>';
                select.disabled = true;
                DOMElements.startBuiltInButton.disabled = true;
                return;
            }

            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "-- Select a Built-in Quiz --";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);

            quizTitlesAndIds.forEach(quiz => {
                const option = document.createElement('option');
                option.value = quiz.id;
                option.textContent = quiz.title;
                select.appendChild(option);
            });

            select.disabled = false;
            DOMElements.startBuiltInButton.disabled = true;

            select.addEventListener('change', function() {
                currentSheetId = this.value;
                DOMElements.quizIdInput.value = '';
                DOMElements.startBuiltInButton.disabled = !this.value;
            });
        }

        // Quiz Flow Control
        function startSelectedQuiz() {
            if (!currentSheetId) {
                Swal.fire('No Quiz Selected', 'Please select a quiz from the dropdown.', 'warning', { confirmButtonColor: primaryColor });
                return;
            }
            startQuizFlow(currentSheetId);
        }

        async function startCustomQuiz() {
            const sheetId = DOMElements.quizIdInput.value.trim();
            if (!sheetId) {
                Swal.fire('Missing Input', 'Please enter a Custom Quiz Google Sheet ID.', 'warning', { confirmButtonColor: primaryColor });
                return;
            }
            currentSheetId = sheetId;
            startQuizFlow(sheetId);
        }

        async function startQuizFlow(sheetId) {
            Swal.fire({ title: 'Loading Quiz', text: 'Please wait...', allowOutsideClick: false, showConfirmButton: false, willOpen: () => Swal.showLoading() });

            const data = await loadSheetData(sheetId);

            if (!data || data.length === 0) {
                Swal.close();
                if (data !== null) {
                    Swal.fire('Empty or Invalid Quiz', 'No valid questions (pairs of words) found in the sheet.', 'warning', { confirmButtonColor: primaryColor });
                }
                return;
            }

            quizData = data;
            resetQuizState(false);
            Swal.close();
            showScreen('nameScreen');
        }

        function resetQuizState(fullReset = true) {
            clearInterval(timerInterval);
            currentQuestion = 0;
            quizData = fullReset ? [] : quizData;
            allTargets = fullReset ? [] : allTargets;
            userData.startTime = 0;
            userData.attempts = [];
            userData.totalPoints = 0;
            timerInterval = null;
            timerPaused = false;
            elapsedTime = 0;
            questionStartTime = 0;
            questionAttempts = {};
            currentCorrectAnswer = '';
            // Reset bullet and game loop
            bulletActive = false;
            DOMElements.bullet.style.display = 'none';
            if (gameLoopId) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
            if (fullReset) {
                 userData.name = '';
                 currentSheetId = '';
                 window.quizTitle = '';
             }
             DOMElements.resultSummary.innerHTML = '';
             DOMElements.resultsTable.innerHTML = '';
             DOMElements.gameArea.innerHTML = '';
             DOMElements.shooter.textContent = '';
             DOMElements.progressBar.style.width = '0%';
             DOMElements.timerDisplay.textContent = '0';
             DOMElements.questionNumberDisplay.textContent = '';
             DOMElements.quizTitleDisplay.textContent = '';
        }

        function startQuiz() {
            userData.name = DOMElements.userNameInput.value.trim();
            if (!userData.name) {
                Swal.fire('Missing Input', 'Please enter your name.', 'warning', { confirmButtonColor: primaryColor });
                return;
            }

            quizData.forEach((_, idx) => { questionAttempts[idx] = 0; });

            showScreen('quizScreen');
            DOMElements.quizTitleDisplay.textContent = window.quizTitle || 'Language Shooter';

            // Position shooter at center (convert from 50% to pixel value for movement)
            const gameAreaRect = DOMElements.gameArea.getBoundingClientRect();
            const shooter = DOMElements.shooter;
            const shooterWidth = shooter.offsetWidth;
            const quizScreenRect = DOMElements.quizScreen.getBoundingClientRect();
            shooter.style.left = (gameAreaRect.left - quizScreenRect.left + (gameAreaRect.width - shooterWidth) / 2) + "px";
            shooter.style.transform = ""; // Remove initial translate

            loadQuestion();
            startTimer();
        }

        // Game Logic
        function loadQuestion() {
             if (currentQuestion >= quizData.length) {
                 showResults();
                 return;
             }
            if (gameLoopId) { cancelAnimationFrame(gameLoopId); gameLoopId = null; }

            const questionData = quizData[currentQuestion];
            currentCorrectAnswer = questionData.colB;

            DOMElements.shooter.textContent = questionData.colA;
            const progress = ((currentQuestion + 1) / quizData.length) * 100;
            DOMElements.progressBar.style.width = `${progress}%`;
            DOMElements.questionNumberDisplay.textContent = `Question ${currentQuestion + 1} of ${quizData.length}`;

            displayTargets();

            questionStartTime = Date.now();
            resumeTimer();

            // Start the game loop for moving targets & bullet updates
            startGameLoop();
        }

        function displayTargets() {
            const gameArea = DOMElements.gameArea;
            gameArea.innerHTML = '';

            const shuffledTargets = shuffle([...allTargets]);

            const areaWidth = gameArea.clientWidth;
            const areaHeight = gameArea.clientHeight;
            const targetPositions = [];

            shuffledTargets.forEach(targetWord => {
                const targetElement = document.createElement('div');
                targetElement.className = 'target';
                targetElement.textContent = targetWord;
                targetElement.dataset.word = targetWord;

                // Assign random horizontal velocity (between 1 and 3 px, random direction) and constant downward speed (1px)
                const randomSpeed = (Math.random() * 2 + 1) * (Math.random() < 0.5 ? -1 : 1);
                targetElement.dataset.vx = randomSpeed;
                targetElement.dataset.vy = 1;

                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 20) {
                    const targetWidthEst = targetWord.length * 12 + 40;
                    const targetHeightEst = 40;

                    const randomLeft = Math.random() * (areaWidth - targetWidthEst);
                    const randomTop = Math.random() * (areaHeight - targetHeightEst - 20);

                    let overlap = false;
                    for (const pos of targetPositions) {
                        if (
                            randomLeft < pos.right &&
                            randomLeft + targetWidthEst > pos.left &&
                            randomTop < pos.bottom &&
                            randomTop + targetHeightEst > pos.top
                        ) {
                            overlap = true;
                            break;
                        }
                    }

                    if (!overlap) {
                        targetElement.style.left = `${randomLeft}px`;
                        targetElement.style.top = `${randomTop}px`;
                        targetPositions.push({
                            left: randomLeft,
                            top: randomTop,
                            right: randomLeft + targetWidthEst,
                            bottom: randomTop + targetHeightEst
                        });
                        placed = true;
                    }
                    attempts++;
                 }
                 if (!placed) {
                     const randomLeft = Math.random() * (areaWidth - 50);
                     const randomTop = Math.random() * (areaHeight - 30);
                     targetElement.style.left = `${randomLeft}px`;
                     targetElement.style.top = `${randomTop}px`;
                 }

                gameArea.appendChild(targetElement);
            });
            // Note: removed click event listener – now using keyboard & game loop collision detection.
        }

        // Game Loop for bullet & target updates
        function startGameLoop() {
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function gameLoop() {
            // Update bullet position if active
            if (bulletActive) {
                bulletY -= bulletSpeed;
                DOMElements.bullet.style.top = bulletY + "px";
                if (bulletY < 0) {
                    bulletActive = false;
                    DOMElements.bullet.style.display = 'none';
                }
            }

            // Update targets' positions
            const targets = DOMElements.gameArea.getElementsByClassName('target');
            const areaWidth = DOMElements.gameArea.clientWidth;
            const areaHeight = DOMElements.gameArea.clientHeight;
            Array.from(targets).forEach(target => {
                let left = parseFloat(target.style.left) || 0;
                let top = parseFloat(target.style.top) || 0;
                let vx = parseFloat(target.dataset.vx) || 0;
                let vy = parseFloat(target.dataset.vy) || 0;

                left += vx;
                top += vy;

                const targetWidth = target.offsetWidth;
                if (left <= 0 || left + targetWidth >= areaWidth) {
                    vx = -vx;
                    target.dataset.vx = vx;
                    left = Math.max(0, Math.min(left, areaWidth - targetWidth));
                }
                target.style.left = left + "px";
                target.style.top = top + "px";
            });

            // Check collision of bullet with targets
            if (bulletActive) {
                Array.from(targets).forEach(target => {
                    if (checkCollision(DOMElements.bullet, target)) {
                        bulletActive = false;
                        DOMElements.bullet.style.display = 'none';
                        if (target.textContent.trim() === currentCorrectAnswer) {
                            target.classList.add('target-hit');
                            cancelAnimationFrame(gameLoopId);
                            const timeTaken = Math.round((Date.now() - questionStartTime) / 1000);
                            const points = calculatePoints(timeTaken);
                            userData.totalPoints += points;
                            userData.attempts.push({
                                question: currentQuestion + 1,
                                colA: quizData[currentQuestion].colA,
                                correctAnswer: currentCorrectAnswer,
                                time: timeTaken,
                                points: points,
                                attempts: questionAttempts[currentQuestion]  // already incremented on fire
                            });
                            DOMElements.gameArea.style.pointerEvents = 'none';
                            setTimeout(() => {
                                Swal.fire({
                                    title: 'Correct!',
                                    text: `+${points} points!`,
                                    icon: 'success',
                                    toast: true,
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 1500,
                                    timerProgressBar: true
                                }).then(() => {
                                    DOMElements.gameArea.style.pointerEvents = 'auto';
                                    currentQuestion++;
                                    if (currentQuestion < quizData.length) {
                                        loadQuestion();
                                    } else {
                                        showResults();
                                    }
                                });
                            }, 400);
                        } else {
                            target.classList.add('target-miss');
                            setTimeout(() => {
                                target.classList.remove('target-miss');
                            }, 300);
                        }
                    }
                });
            }

            // Check if any target reaches shooter’s vertical level
            const shooterRect = DOMElements.shooter.getBoundingClientRect();
            Array.from(targets).forEach(target => {
                const targetRect = target.getBoundingClientRect();
                if (targetRect.bottom >= shooterRect.top) {
                    cancelAnimationFrame(gameLoopId);
                    Swal.fire({
                        title: 'Time Up!',
                        text: 'A target reached your shooter!',
                        icon: 'error',
                        showCancelButton: true,
                        confirmButtonText: 'Try Again',
                        cancelButtonText: 'Continue (0 points)',
                        confirmButtonColor: primaryColor,
                        cancelButtonColor: textSecondary,
                        reverseButtons: true
                    }).then(result => {
                        if (result.isConfirmed) {
                            loadQuestion();
                        } else {
                            currentQuestion++;
                            if (currentQuestion < quizData.length) {
                                loadQuestion();
                            } else {
                                showResults();
                            }
                        }
                    });
                }
            });

            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function checkCollision(el1, el2) {
            const rect1 = el1.getBoundingClientRect();
            const rect2 = el2.getBoundingClientRect();
            return !(rect1.right < rect2.left || rect1.left > rect2.right || rect1.bottom < rect2.top || rect1.top > rect2.bottom);
        }

        // Keyboard controls for shooter movement and bullet firing
        document.addEventListener('keydown', handleKeyDown);
        function handleKeyDown(e) {
            if (!document.getElementById('quizScreen').classList.contains('active')) return;
            const shooter = DOMElements.shooter;
            const gameAreaRect = DOMElements.gameArea.getBoundingClientRect();
            const shooterRect = shooter.getBoundingClientRect();
            const quizScreenRect = DOMElements.quizScreen.getBoundingClientRect();
            const moveDistance = 15;
            if (e.key === 'ArrowLeft') {
                let newLeft = shooterRect.left - moveDistance;
                if (newLeft < gameAreaRect.left) newLeft = gameAreaRect.left;
                shooter.style.left = (newLeft - quizScreenRect.left) + "px";
            } else if (e.key === 'ArrowRight') {
                let newLeft = shooterRect.left + moveDistance;
                if (newLeft + shooterRect.width > gameAreaRect.right) newLeft = gameAreaRect.right - shooterRect.width;
                shooter.style.left = (newLeft - quizScreenRect.left) + "px";
            } else if (e.key === ' ') {
                if (!bulletActive) {
                    fireBullet();
                }
            }
        }

        function fireBullet() {
            // Increment attempt count for the current question
            questionAttempts[currentQuestion] = (questionAttempts[currentQuestion] || 0) + 1;
            const gameAreaRect = DOMElements.gameArea.getBoundingClientRect();
            const shooterRect = DOMElements.shooter.getBoundingClientRect();
            bulletActive = true;
            bulletX = shooterRect.left + shooterRect.width / 2 - gameAreaRect.left - DOMElements.bullet.offsetWidth / 2;
            bulletY = shooterRect.top - gameAreaRect.top - DOMElements.bullet.offsetHeight;
            DOMElements.bullet.style.left = bulletX + "px";
            DOMElements.bullet.style.top = bulletY + "px";
            DOMElements.bullet.style.display = 'block';
        }

        // Timer Functions
        function startTimer() {
            clearInterval(timerInterval);
            elapsedTime = 0;
            DOMElements.timerDisplay.textContent = elapsedTime;
            timerPaused = false;
            userData.startTime = Date.now();
            timerInterval = setInterval(() => {
                if (!timerPaused) {
                    elapsedTime = Math.floor((Date.now() - userData.startTime) / 1000);
                    DOMElements.timerDisplay.textContent = elapsedTime;
                }
            }, 1000);
        }
        function pauseTimer() { timerPaused = true; }
        function resumeTimer() { timerPaused = false; }

        // Scoring
        function calculatePoints(seconds) {
            const brackets = [[5,10],[10,9],[15,8],[20,7],[25,6],[30,5],[40,4],[50,3],[60,2],[Infinity,1]];
            for (const [max, points] of brackets) {
                if (seconds <= max) return points;
            }
            return 0;
        }

        // Utility
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Results Display
        function showResults() {
            clearInterval(timerInterval);
            showScreen('resultsScreen');

            const completionDate = new Date();
            const day = completionDate.getDate().toString().padStart(2, '0');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = monthNames[completionDate.getMonth()];
            const year = completionDate.getFullYear();
            const hours = completionDate.getHours().toString().padStart(2, '0');
            const minutes = completionDate.getMinutes().toString().padStart(2, '0');
            const seconds = completionDate.getSeconds().toString().padStart(2, '0');
            const completionTimestamp = `${day} ${month} ${year}, ${hours}:${minutes}:${seconds}`;

            const correctCount = userData.attempts.length;

            DOMElements.resultSummary.innerHTML = `
                <div class="result-stat">
                    <i class="fas fa-user"></i>
                    <span><strong>Name:</strong> ${userData.name || 'N/A'}</span>
                </div>
                <div class="result-stat">
                    <i class="fas fa-calendar-check"></i>
                    <span><strong>Completed:</strong> ${completionTimestamp}</span>
                </div>
                <div class="result-stat">
                     <i class="fas fa-book"></i>
                    <span><strong>Quiz Title:</strong> ${window.quizTitle || 'N/A'}</span>
                </div>
                <div class="result-stat">
                    <i class="fas fa-trophy"></i>
                    <span><strong>Total Score:</strong> ${userData.totalPoints} points</span>
                </div>
                <div class="result-stat">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    <span><strong>Correct Answers:</strong> ${correctCount} / ${quizData.length}</span>
                </div>
            `;

            const table = DOMElements.resultsTable;
            let tableHTML = `
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Word</th>
                        <th>Correct Match</th>
                        <th>Time (s)</th>
                        <th>Attempts</th>
                        <th>Points</th>
                    </tr>
                </thead>
                <tbody>`;

             for (let i = 0; i < quizData.length; i++) {
                 const questionNum = i + 1;
                 const attemptData = userData.attempts.find(a => a.question === questionNum);
                 const totalAttemptsForQ = questionAttempts[i] || 0;

                 if (attemptData) {
                     tableHTML += `
                        <tr>
                            <td>${attemptData.question}</td>
                            <td>${attemptData.colA}</td>
                            <td class="correct">${attemptData.correctAnswer}</td>
                            <td>${attemptData.time}</td>
                            <td>${attemptData.attempts}</td>
                            <td>${attemptData.points}</td>
                        </tr>
                    `;
                 } else {
                     tableHTML += `
                        <tr>
                            <td>${questionNum}</td>
                            <td>${quizData[i].colA}</td>
                             <td class="incorrect"><em>Not Answered</em> (${quizData[i].colB})</td>
                            <td>-</td>
                            <td>${totalAttemptsForQ}</td>
                            <td>0</td>
                        </tr>
                    `;
                 }
             }

            tableHTML += `</tbody>`;
            table.innerHTML = tableHTML;
        }

        // Results Actions
        function screenshotResults() {
            Swal.fire({ title: 'Generating Screenshot', text: 'Please wait...', allowOutsideClick: false, showConfirmButton: false, willOpen: () => Swal.showLoading() });

            const resultsElement = DOMElements.resultsScreen.querySelector('.card');

            html2canvas(resultsElement, { scale: 2, useCORS: true }).then(canvas => {
                Swal.close();
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `LanguageShooter-Results-${userData.name || 'User'}-${timestamp}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                Swal.fire('Success!', 'Results screenshot downloaded.', 'success', { confirmButtonColor: primaryColor });
            }).catch(err => {
                Swal.close();
                console.error("Screenshot error:", err);
                Swal.fire('Error', 'Could not generate screenshot.', 'error', { confirmButtonColor: primaryColor });
            });
        }

        function reviewQuestions() {
             Swal.fire({
                title: 'Play Again?',
                text: 'Do you want to restart the same quiz? Your previous results for this session will be cleared.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Restart Quiz',
                cancelButtonText: 'No, Go Home',
                confirmButtonColor: primaryColor,
                cancelButtonColor: textSecondary,
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    if (!currentSheetId) {
                         Swal.fire("Error", "Cannot determine which quiz to restart.", "error");
                         goHome();
                         return;
                    }
                    startQuizFlow(currentSheetId);
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    goHome();
                }
            });
        }
    </script>
</body>
</html>
