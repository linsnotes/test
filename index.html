<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Book List Builder</title>

<!-- Library for XLSX Export -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

<style>
/* Basic Styles & Layout */
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  line-height: 1.6;
  background-color: #f4f5f7;
  color: #172b4d;
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  background-color: #ffffff;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  padding: 24px;
}
header {
  border-bottom: 1px solid #dfe1e6;
  padding-bottom: 16px;
  margin-bottom: 24px;
}
h1 { margin: 0 0 4px 0; }
h2 { margin-top: 32px; border-bottom: 1px solid #dfe1e6; padding-bottom: 8px;}
.subtitle { color: #5e6c84; }

/* Forms & Filters */
.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  align-items: end;
}
.form-group { display: flex; flex-direction: column; }
label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #5e6c84;
  margin-bottom: 4px;
}
input[type="text"], select {
  width: 100%;
  padding: 8px 12px;
  border-radius: 4px;
  border: 1px solid #c1c7d0;
  background-color: #fafbfc;
  box-sizing: border-box; /* Ensures padding doesn't affect width */
}
input[type="text"]:focus, select:focus {
  border-color: #4c9aff;
  outline: none;
  box-shadow: 0 0 0 2px rgba(76,154,255,0.3);
}
.checkbox-group {
  display: flex;
  align-items: center;
  padding-top: 24px;
}
.checkbox-group input { margin-right: 8px; }

/* Buttons */
.button-group {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.btn {
  border: none;
  border-radius: 4px;
  padding: 10px 16px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
  transition: background-color 0.2s;
}
.btn.primary { background-color: #007bff; color: white; }
.btn.primary:hover { background-color: #0056b3; }
.btn.secondary { background-color: #6c757d; color: white; }
.btn.secondary:hover { background-color: #5a6268; }
.btn.success { background-color: #28a745; color: white; font-size: 0.8rem; padding: 4px 10px; }
.btn.danger { background-color: #dc3545; color: white; font-size: 0.8rem; padding: 4px 10px; }
.btn.ghost { background-color: transparent; color: #6c757d; border: 1px solid #dfe1e6; }
.btn.ghost:hover { background-color: #f4f5f7; }

/* Tables */
.table-wrapper { overflow-x: auto; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  table-layout: fixed; /* keep columns predictable */
}
th, td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #dfe1e6;
  white-space: nowrap;
  overflow: hidden;              /* prevent text spill */
  text-overflow: ellipsis;       /* nicer truncation */
  vertical-align: top;
}
th {
  background-color: #f4f5f7;
  font-size: 0.85rem;
  text-transform: uppercase;
  color: #5e6c84;
}
tr:last-child td { border-bottom: none; }
.chip {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 500;
  color: #172b4d;
}
.chip.compulsory { background-color: #e6ffed; border: 1px solid #57d9a3; }

/* Helper Classes */
.message {
  text-align: center;
  padding: 40px 20px;
  background-color: #fafbfc;
  border-radius: 4px;
  color: #5e6c84;
  margin-top: 16px;
  border: 1px dashed #c1c7d0;
}
.status-message { margin: 16px 0; color: #5e6c84; }
.my-list-header {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  flex-wrap: wrap; /* prevent header crowding on small widths */
}

/* --- Fixed column widths (sum to 100%) via <colgroup> --- */
/* RESULTS table (unchanged totals = 100%) */
#resultsTable col.title    { width: 40%; }
#resultsTable col.subject  { width: 14%; }
#resultsTable col.publisher{ width: 16%; }
#resultsTable col.isbn     { width: 14%; }
#resultsTable col.price    { width: 8%; }
#resultsTable col.action   { width: 8%; }

/* MY LIST table (FIX: includes SN and rebalances to 100%) */
#myListTable col.sn        { width: 8%; }   /* NEW: explicit SN width */
#myListTable col.title     { width: 36%; }  /* was 40% */
#myListTable col.subject   { width: 14%; }
#myListTable col.publisher { width: 14%; }  /* was 16% */
#myListTable col.isbn      { width: 12%; }  /* was 14% */
#myListTable col.price     { width: 8%; }
#myListTable col.action    { width: 8%; }

/* Keep some cells compact */
td.isbn-cell, td.price-cell, td.sn-cell { white-space: nowrap; }

/* Let long titles wrap/clamp (override the global nowrap) */
td.title-cell{
  white-space: normal;
  overflow: hidden;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;   /* clamp to 2 lines on desktop */
  overflow-wrap: anywhere;
}
td.title-cell .chip { margin-left: 8px; }

/* Sticky Action column on desktop so buttons are always visible */
th.action-col, td.action-cell {
  position: sticky;
  right: 0;
  background: #fff;
  box-shadow: -8px 0 8px -8px rgba(0,0,0,0.12);
  z-index: 1;
}

/* Mobile-first enhancements */
.add-btn-inline { display: none; }

/* Under 900px: hide less-important cols, show inline Add inside title */
@media (max-width: 900px){
  .hide-sm { display: none; }
  th.action-col, td.action-cell { display: none; } /* hide far-right action column */
  .add-btn-inline { display: inline-block; margin-left: 8px; }
  td.title-cell { -webkit-line-clamp: 3; } /* give long titles a bit more room */

  /* Better button organization */
  .button-group .btn { flex: 1 1 48%; }
}

/* --- True card layout under 640px --- */
@media (max-width: 640px){
  .container { padding: 16px; }

  .hide-sm { display: grid; }  /* show as rows inside cards */

  /* Make the table render as a list of cards */
  #resultsTable thead, #myListTable thead { display: none; }

  #resultsTable tr, #myListTable tr {
    display: grid;
    gap: 8px;
    padding: 12px;
    margin: 12px 0;
    border: 1px solid #e6e8eb;
    border-radius: 8px;
    background: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  /* RESULTS: Title, Subject, Publisher, ISBN, Price, Action */
  #resultsTable tr{
    grid-template-areas:
      "title"
      "subject"
      "publisher"
      "isbn"
      "price"
      "action";
  }
  #resultsTable td:nth-child(1){ grid-area: title; }
  #resultsTable td:nth-child(2){ grid-area: subject; }
  #resultsTable td:nth-child(3){ grid-area: publisher; }
  #resultsTable td:nth-child(4){ grid-area: isbn; }
  #resultsTable td:nth-child(5){ grid-area: price; }
  #resultsTable td:nth-child(6){ grid-area: action; }

  /* MY LIST: SN, Subject, Title, Publisher, ISBN, Price, Action */
  #myListTable tr{
    grid-template-areas:
      "title"
      "subject"
      "sn"
      "publisher"
      "isbn"
      "price"
      "action";
  }
  #myListTable td:nth-child(1){ grid-area: sn; }
  #myListTable td:nth-child(2){ grid-area: subject; }
  #myListTable td:nth-child(3){ grid-area: title; }
  #myListTable td:nth-child(4){ grid-area: publisher; }
  #myListTable td:nth-child(5){ grid-area: isbn; }
  #myListTable td:nth-child(6){ grid-area: price; }
  #myListTable td:nth-child(7){ grid-area: action; }

  /* Show labels on the left for non-title rows using data-label */
  #resultsTable td, #myListTable td{
    white-space: normal;  /* override global nowrap so values wrap in cards */
    display: grid;
    grid-template-columns: 40% 1fr;
    align-items: start;
    overflow: visible; /* allow wrapping content */
    text-overflow: clip;
  }
  #resultsTable td::before, #myListTable td::before{
    content: attr(data-label);
    font-weight: 600;
    color: #6b778c;
    padding-right: 10px;
  }

  /* Make the Title act like a card header (no left label) */
  #resultsTable td.title-cell::before,
  #myListTable td.title-cell::before{ content: ""; display: none; }

  #resultsTable td.title-cell,
  #myListTable td.title-cell{
    display: -webkit-box; 
    -webkit-box-orient: vertical;  /* required for clamp */
    -webkit-line-clamp: 4;
    font-size: 1rem;
    font-weight: 600;
  }

  /* Bring the Action back inside the card (bottom row) */
  #resultsTable td.action-cell,
  #myListTable td.action-cell{
    display: block !important;     /* override earlier hide */
  }
  #resultsTable td.action-cell::before,
  #myListTable td.action-cell::before{ content: ""; display: none; }
  #resultsTable td.action-cell .btn,
  #myListTable td.action-cell .btn{ width: 100%; }

  /* Buttons stack cleanly on very small screens */
  .button-group { gap: 8px; }
  .button-group .btn { flex: 1 1 100%; }

/* ---- Collapsed/expanded card layout for results (mobile only) ---- */

/* Base: 2 columns (content + right rail for price/action) */
#resultsTable tr {
  grid-template-columns: 1fr 140px;     /* right column wide enough for price + button */
  grid-template-areas:
    "title title"
    "price action";                      /* collapsed default shows price + action */
}

/* Expanded: reveal subject/publisher/isbn between title and footer */
#resultsTable tr.expanded {
  grid-template-areas:
    "title title"
    "subject subject"
    "publisher publisher"
    "isbn isbn"
    "price action";
}

/* Map cells into areas (already present, kept here for clarity) */
#resultsTable td:nth-child(1){ grid-area: title; }
#resultsTable td:nth-child(2){ grid-area: subject; }
#resultsTable td:nth-child(3){ grid-area: publisher; }
#resultsTable td:nth-child(4){ grid-area: isbn; }
#resultsTable td:nth-child(5){ grid-area: price; }
#resultsTable td:nth-child(6){ grid-area: action; }

/* Hide metadata by default (collapsed), reveal when expanded */
#resultsTable tr:not(.expanded) td:nth-child(2),
#resultsTable tr:not(.expanded) td:nth-child(3),
#resultsTable tr:not(.expanded) td:nth-child(4) {
  display: none;
}

/* Title row becomes a clean header */
#resultsTable td.title-cell {
  position: relative;
  padding-right: 44px;                   /* room for chevron */
  -webkit-line-clamp: 3;                 /* slightly roomier on mobile */
  margin-bottom: 2px;
}

/* Right-side footer row: align price + button neatly */
#resultsTable td.price-cell,
#resultsTable td.action-cell {
  display: flex !important;
  align-items: center;
  gap: 8px;
}
#resultsTable td.price-cell { justify-content: flex-start; }
#resultsTable td.action-cell { justify-content: flex-end; }

/* Hide labels for price/action; keep labels for meta fields when expanded */
#resultsTable td.price-cell::before,
#resultsTable td.action-cell::before { display: none; }

/* Meta block cosmetics (only visible in expanded state) */
#resultsTable tr.expanded td:nth-child(2),
#resultsTable tr.expanded td:nth-child(3),
#resultsTable tr.expanded td:nth-child(4) {
  border-top: 1px dashed #e6e8eb;
  padding-top: 6px;
  color: #2e3a4a;
}

/* Chevron toggle: touch-friendly, right-aligned in the title cell */
#resultsTable .card-toggle {
  position: absolute;
  right: 8px;
  top: 8px;
  width: 28px;
  height: 28px;
  border: 1px solid #dfe1e6;
  border-radius: 50%;
  background: #fff;
  cursor: pointer;
}
#resultsTable .card-toggle::before {
  content: "⌄";                           /* simple chevron */
  display: block;
  font-size: 16px;
  line-height: 26px;
  text-align: center;
}
#resultsTable tr.expanded .card-toggle::before {
  transform: rotate(180deg);
}
#resultsTable .card-toggle:active {
  background: #f4f5f7;
}

/* Tighter label/value grid so values get more room */
#resultsTable td { grid-template-columns: 35% 1fr; }  /* was 40% 1fr */

/* Buttons: full width on the smallest screens */
.button-group { gap: 8px; }
.button-group .btn { flex: 1 1 100%; }



  
}



  
</style>
</head>
<body>

  <div class="container">
    <header>
      <h1>Book List Builder</h1>
      <p class="subtitle">Filter textbooks and create a custom printable book list.</p>
    </header>

    <!-- Filters Section -->
    <section id="filters">
      <h2>1. Find Books</h2>
      <form id="filtersForm">
        <div class="filters-grid">
          <div class="form-group">
            <label for="level">Level</label>
            <select id="level"><option value="">All Levels</option></select>
          </div>
          <div class="form-group">
            <label for="subject">Subject</label>
            <select id="subject"><option value="">All Subjects</option></select>
          </div>
          <div class="form-group">
            <label for="banding">Banding</label>
            <select id="banding"><option value="">All Bandings</option></select>
          </div>
          <div class="form-group">
            <label for="search">Title Keyword</label>
            <input id="search" type="text" placeholder="e.g., Workbook, 1A, etc." />
          </div>
          <div class="form-group checkbox-group">
            <input id="compOnly" type="checkbox" />
            <label for="compOnly">Show compulsory books only</label>
          </div>
        </div>
        <div class="button-group" style="margin-top: 20px;">
          <button type="submit" class="btn primary">Apply Filters</button>
          <button type="button" id="resetBtn" class="btn ghost">Reset Filters</button>
        </div>
      </form>
    </section>

    <!-- Results Section -->
    <section id="results-section">
      <h2>2. Search Results</h2>
      <div id="resultsCounter" class="status-message">Loading books...</div>
      <div class="table-wrapper">

      <table id="resultsTable">
          <colgroup>
            <col class="title">
            <col class="subject">
            <col class="publisher">
            <col class="isbn">
            <col class="price">
            <col class="action">
          </colgroup>
          <thead>
            <tr>
              <th>Title</th>
              <th>Subject</th>
              <th class="hide-sm">Publisher</th>
              <th class="hide-sm">ISBN</th>
              <th>Price</th>
              <th class="action-col">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

      </div>
      <div id="resultsMessage" class="message" style="display: none;"></div>
    </section>

    <!-- My Book List Section -->
    <section id="my-list-section">
      <div class="my-list-header">
        <h2>3. My Book List</h2>
      </div>
      <div class="button-group">
        <button id="clearBtn" class="btn secondary">Clear List</button>
        <button id="xlsxBtn" class="btn primary">Download XLSX</button>
      </div>
      <div id="myListCounter" class="status-message">Your list is empty.</div>
      <div class="table-wrapper">

        <table id="myListTable">
          <colgroup>
            <col class="sn">
            <col class="subject">
            <col class="title">
            <col class="publisher">
            <col class="isbn">
            <col class="price">
            <col class="action">
          </colgroup>
          <thead>
            <tr>
              <th>SN</th>
              <th>Subject</th>
              <th>Title</th>
              <th class="hide-sm">Publisher</th>
              <th class="hide-sm">ISBN</th>
              <th>Price</th>
              <th class="action-col">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

      </div>
       <div id="myListEmpty" class="message">Add books from the search results above.</div>
    </section>

  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ===== Configuration =====
    // IMPORTANT: Replace with your Google Sheet ID.
    // The sheet must be shared with "Anyone with the link can view".
    const SHEET_ID = '1BKnMBNfnrVz0M317AysbuheMYS_TB_sbKrKCPUC386U';
    const XLSX_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=xlsx`;

    // options
    const ALL = "ALL";
    const SELECT = "SELECT";
    const isAll = v => v === ALL;
    const isSelect = v => v === SELECT;
    const matches = (filter, value) => isAll(filter) || value === filter;

    const LABELS = {
      level:   { singular: 'Level',   plural: 'Levels' },
      subject: { singular: 'Subject', plural: 'Subjects' },
      banding: { singular: 'Banding', plural: 'Bandings' },
    };
    

    // ===== DOM Elements =====
    const $ = sel => document.querySelector(sel);
    const resultsTableBody = $('#resultsTable tbody');
    const myListTableBody = $('#myListTable tbody');
    const resultsCounter = $('#resultsCounter');
    const myListCounter = $('#myListCounter');
    const resultsMessage = $('#resultsMessage');
    const myListEmpty = $('#myListEmpty');

    // ===== State =====
    let allBooks = [];
    let filteredBooks = [];
    const myBookList = new Map(); // Use Map to prevent duplicates and easily manage items.
    let awaitSelection = true; // while any dropdown is "Select", show empty result


    // ===== Utility Functions =====
    const normalize = v => (v ?? '').toString().trim();
    const isCompulsory = v => /^y(es)?$/i.test(normalize(v));

    /**
     * Maps spreadsheet header names to required object keys.
     * This makes the code resilient to column reordering.
     */
    function getHeaderMap(headerRow) {
      const map = {};
      const neededKeys = {
        'sn': 'sn', 'level': 'level', 'subject': 'subject', 'banding': 'banding',
        'title': 'title', 'compulsory': 'compulsory', 'publisher': 'publisher',
        'isbn': 'isbn', 'price': 'price'
      };
      headerRow.forEach((header, index) => {
        const key = normalize(header).toLowerCase();
        if (neededKeys[key]) {
          map[neededKeys[key]] = index;
        }
      });
      const missing = Object.keys(neededKeys).filter(k => map[k] === undefined);
      if (missing.length) {
        throw new Error(`The spreadsheet is missing required columns: ${missing.join(', ')}`);
      }
      return map;
    }

    /**
     * Converts raw 2D array data from the spreadsheet into an array of book objects.
     */
    function processSheetData(rows2D) {
      if (rows2D.length < 2) return []; // No data rows
      const headerMap = getHeaderMap(rows2D[0]);
      const books = [];
      for (let i = 1; i < rows2D.length; i++) {
        const row = rows2D[i];
        if (!row || !normalize(row[headerMap.title])) continue; // Skip empty rows or rows without a title

        books.push({
          sn: normalize(row[headerMap.sn]),
          level: normalize(row[headerMap.level]),
          subject: normalize(row[headerMap.subject]),
          banding: normalize(row[headerMap.banding]),
          title: normalize(row[headerMap.title]),
          compulsory: isCompulsory(row[headerMap.compulsory]),
          publisher: normalize(row[headerMap.publisher]),
          isbn: normalize(row[headerMap.isbn]),
          price: parseFloat(normalize(row[headerMap.price])) || 0
        });
      }
      return books;
    }

    /**
     * Populates a <select> with:
     * 1) Select (default, yields empty results)
     * 2) All ...
     * 3) Actual values
     */
    function populateSelect(selectElement, values, currentValue) {
      const uniqueValues = [...new Set(values.filter(Boolean))]
        .sort((a,b) => a.localeCompare(b, 'en', { numeric: true }));

      const { singular, plural } = LABELS[selectElement.id] || { singular: 'Option', plural: 'Options' };

      // Build options
      selectElement.innerHTML = `
        <option value="${SELECT}">Select ${singular}</option>
        <option value="${ALL}">All ${plural}</option>
      `;

      uniqueValues.forEach(val => {
        const option = document.createElement('option');
        option.value = val;
        option.textContent = val;
        selectElement.appendChild(option);
      });

      // Default to SELECT unless a specific currentValue is provided
      selectElement.value = currentValue && currentValue !== "" ? currentValue : SELECT;
    }


    function populateFilters() {
      const levelSel = $('#level');
      const subjectSel = $('#subject');
      const bandingSel = $('#banding');

      // Preserve current filter values
      const current = {
        level: levelSel.value || SELECT,
        subject: subjectSel.value || SELECT,
        banding: bandingSel.value || SELECT
      };

      // Build Level options from all books
      populateSelect(levelSel, allBooks.map(b => b.level), current.level);

      // If level is ALL or SELECT, use full pool; else filter by level
      const subjectPool = (isAll(current.level) || isSelect(current.level))
        ? allBooks
        : allBooks.filter(b => b.level === current.level);
      populateSelect(subjectSel, subjectPool.map(b => b.subject), current.subject);

      // If subject is ALL or SELECT, use subjectPool; else filter by subject
      const bandingPool = (isAll(current.subject) || isSelect(current.subject))
        ? subjectPool
        : subjectPool.filter(b => b.subject === current.subject);
      populateSelect(bandingSel, bandingPool.map(b => b.banding), current.banding);
    }

    // helper: treat SELECT like no constraint during filtering
    const effective = v => (isSelect(v) ? ALL : v);

    function applyFilters(event) {
      if (event) event.preventDefault();

      const level = $('#level').value;
      const subject = $('#subject').value;
      const banding = $('#banding').value;
      const compOnly = $('#compOnly').checked;
      const keyword = $('#search').value.trim().toLowerCase();

      // Friendly gating: only block when ALL three are still Select and no other constraint
      const anyChosen = ![level, subject, banding].every(isSelect);
      const hasOtherConstraints = compOnly || !!keyword;

      awaitSelection = !(anyChosen || hasOtherConstraints);
      if (awaitSelection) {
        filteredBooks = [];
        renderResultsTable();
        return;
      }

      // Normal filtering; SELECT behaves like ALL (no constraint)
      filteredBooks = allBooks.filter(book =>
        matches(effective(level),   book.level)   &&
        matches(effective(subject), book.subject) &&
        matches(effective(banding), book.banding) &&
        (!compOnly || book.compulsory) &&
        (!keyword || book.title.toLowerCase().includes(keyword))
      );

      renderResultsTable();
    }

    
    function renderResultsTable() {
      resultsTableBody.innerHTML = ''; // Clear previous results

      if (filteredBooks.length === 0) {
        $('#resultsTable').style.display = 'none';
        resultsMessage.style.display = 'block';
        resultsMessage.textContent = awaitSelection
          ? 'Choose any filter (or “All”), type a keyword, or tick Compulsory to see books.'
          : 'No books match your current filters.';
      } else {
        resultsMessage.style.display = 'none';
        $('#resultsTable').style.display = '';

        filteredBooks.forEach(book => {
          const row = document.createElement('tr');
          const isAdded = myBookList.has(book.sn);
          row.innerHTML = `
            <td class="title-cell" data-label="Title" title="${book.title}">
              ${book.title}
              ${book.compulsory ? '<span class="chip compulsory">Compulsory</span>' : ''}
              <button class="btn success add-btn add-btn-inline" data-sn="${book.sn}" ${isAdded ? 'disabled' : ''}>
                ${isAdded ? 'Added' : 'Add'}
              </button>
              <button class="card-toggle" aria-expanded="false" aria-label="Show details"></button>
            </td>
            <td data-label="Subject">${book.subject}</td>
            <td class="hide-sm" data-label="Publisher">${book.publisher}</td>
            <td class="isbn-cell hide-sm" data-label="ISBN">${book.isbn}</td>
            <td class="price-cell" data-label="Price">${book.price.toFixed(2)}</td>
            <td class="action-cell" data-label="">
              <button class="btn success add-btn" data-sn="${book.sn}" ${isAdded ? 'disabled' : ''}>
                ${isAdded ? 'Added' : 'Add'}
              </button>
            </td>
          `;
          resultsTableBody.appendChild(row);
        });
      }

      resultsCounter.textContent = awaitSelection
        ? 'Waiting for selections…'
        : `${filteredBooks.length} book(s) found.`;
    }
    

    /**
     * Renders the user's selected books into the "My Book List" table.
     */
    function renderMyListTable() {
      myListTableBody.innerHTML = '';
      const listItems = Array.from(myBookList.values());

      if (listItems.length === 0) {
        myListEmpty.style.display = 'block';
        $('#myListTable').style.display = 'none';
      } else {
        myListEmpty.style.display = 'none';
        $('#myListTable').style.display = '';
        
        // Sort by SN for consistent ordering
        listItems.sort((a,b) => a.sn.localeCompare(b, 'en', { numeric: true }));

        listItems.forEach(book => {
          const row = document.createElement('tr');
           row.innerHTML = `
            <td class="sn-cell" data-label="SN">${book.sn}</td>
            <td data-label="Subject">${book.subject}</td>
            <td class="title-cell" data-label="Title" title="${book.title}">${book.title}</td>
            <td class="hide-sm" data-label="Publisher">${book.publisher}</td>
            <td class="isbn-cell hide-sm" data-label="ISBN">${book.isbn}</td>
            <td class="price-cell" data-label="Price">${book.price.toFixed(2)}</td>
            <td class="action-cell" data-label="">
              <button class="btn danger remove-btn" data-sn="${book.sn}">Remove</button>
            </td>
          `;
          myListTableBody.appendChild(row);
        });
      }

      const totalItems = listItems.length;
      const totalPrice = listItems.reduce((sum, book) => sum + book.price, 0);
      myListCounter.textContent = `${totalItems} item(s) in your list. Total Price: $${totalPrice.toFixed(2)}`;
    }

    /**
     * Handles clicks within the results table (e.g., "Add" buttons).
     */

    function handleResultsClick(event) {
      // 1) Add button logic (existing)
      if (event.target.classList.contains('add-btn')) {
        const sn = event.target.dataset.sn;
        const bookToAdd = filteredBooks.find(b => b.sn === sn);
        if (bookToAdd && !myBookList.has(sn)) {
          myBookList.set(sn, bookToAdd);
          document.querySelectorAll(`.add-btn[data-sn="${sn}"]`).forEach(btn => {
            btn.disabled = true;
            btn.textContent = 'Added';
          });
          renderMyListTable();
        }
        return;
      }

      // 2) NEW: expand/collapse toggle (mobile cards)

      if (event.target.classList.contains('card-toggle')) {
        const tr = event.target.closest('tr');
        const tbody = tr.parentElement;
        // close others
        tbody.querySelectorAll('tr.expanded').forEach(row => {
          if (row !== tr) {
            row.classList.remove('expanded');
            row.querySelector('.card-toggle')?.setAttribute('aria-expanded', 'false');
          }
        });
        // toggle current
        const expanded = tr.classList.toggle('expanded');
        event.target.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      }
    }



    

    /**
     * Handles clicks within the "My List" table (e.g., "Remove" buttons).
     */
    function handleMyListClick(event) {
      if (event.target.classList.contains('remove-btn')) {
        const sn = event.target.dataset.sn;
        if (myBookList.has(sn)) {
          myBookList.delete(sn);
          renderMyListTable();
          renderResultsTable(); // Re-render results to update "Add/Added" button states
        }
      }
    }
    
    /**
     * Clears all items from "My Book List".
     */
    function clearMyList() {
        if (confirm('Are you sure you want to clear your entire book list?')) {
            myBookList.clear();
            renderMyListTable();
            renderResultsTable(); // Update button states in results
        }
    }

    /**
     * Generates and downloads an XLSX file from the "My Book List" data.
     */
    function downloadXLSX() {
        if (myBookList.size === 0) {
            alert('Your book list is empty. Add some books before downloading.');
            return;
        }

        const listItems = Array.from(myBookList.values())
          .sort((a,b) => a.sn.localeCompare(b, 'en', { numeric: true }));

        const headers = ['SN', 'Subject', 'Title', 'Publisher', 'ISBN', 'Price'];
        const data = listItems.map(book => [
            book.sn,
            book.subject,
            book.title,
            book.publisher,
            book.isbn,
            book.price,
        ]);

        const worksheetData = [headers, ...data];
        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
        
        // Auto-fit column widths
        const colWidths = headers.map((_, i) => ({
            wch: worksheetData.reduce((w, r) => Math.max(w, (r[i] || '').toString().length), 10)
        }));
        worksheet['!cols'] = colWidths;
        
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'My Book List');

        XLSX.writeFile(workbook, 'MyBookList.xlsx');
    }

    /**
     * Fetches and loads the book data from the Google Sheet.
     */
    async function loadInitialData() {
      try {
        const response = await fetch(XLSX_URL);
        if (!response.ok) {
          throw new Error(`Network error: ${response.statusText}. Ensure the Google Sheet is published and shared correctly.`);
        }
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

        allBooks = processSheetData(data);

        // Start empty until user picks filters
        filteredBooks = [];
        awaitSelection = true;

        populateFilters();
        renderResultsTable();
        renderMyListTable();

      } catch (error) {
        console.error('Failed to load or process sheet:', error);
        resultsCounter.textContent = '';
        resultsMessage.innerHTML = `<strong>Error loading book data.</strong><br>${error.message}<br>Please check the SHEET_ID and that the sheet is published to the web.`;
        resultsMessage.style.display = 'block';
        $('#resultsTable').style.display = 'none';
      }
    }

    // ===== Event Listeners =====
    $('#filtersForm').addEventListener('submit', applyFilters);
    $('#resetBtn').addEventListener('click', () => {
        $('#filtersForm').reset();
        populateFilters(); // Repopulate to reset dependent dropdowns
        applyFilters();
    });

    // Use event delegation for dynamic dropdown changes
    $('#filters').addEventListener('change', event => {
        if (event.target.tagName === 'SELECT') {
            if (event.target.id === 'level' || event.target.id === 'subject') {
                populateFilters();
            }
            applyFilters();
        }
        if(event.target.type === 'checkbox') {
            applyFilters();
        }
    });
    $('#search').addEventListener('input', applyFilters);

    resultsTableBody.addEventListener('click', handleResultsClick);
    myListTableBody.addEventListener('click', handleMyListClick);
    $('#clearBtn').addEventListener('click', clearMyList);
    $('#xlsxBtn').addEventListener('click', downloadXLSX);

    // ===== Initial Load =====
    loadInitialData();
  });
  </script>
</body>
</html>
