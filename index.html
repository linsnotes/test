<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-t" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>听写 · Tingxie App</title>
  <meta name="theme-color" content="#6c5ce7" />
  <style>
    :root{
      --bg: #0f1226; /* deep indigo */
      --panel: rgba(255,255,255,0.08);
      --panel-2: rgba(255,255,255,0.14);
      --text: #f5f7ff;
      --muted: #c8cff7;
      --brand: #6c5ce7; /* purple */
      --brand-2: #00d4ff; /* aqua */
      --ok: #2ecc71;
      --warn: #f1c40f;
      --err: #ff7675;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text); background:
        radial-gradient(1200px 600px at -10% -10%, #1b1644 0%, transparent 50%),
        radial-gradient(1200px 600px at 110% 10%, #12233f 0%, transparent 50%),
        radial-gradient(1200px 600px at 50% 120%, #1a2a6c 0%, transparent 50%),
        var(--bg);
    }

    .container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

    header{
      position: sticky; top:0; z-index: 5; backdrop-filter: saturate(1.2) blur(8px);
      background: linear-gradient(180deg, rgba(10,12,30,0.8), rgba(10,12,30,0.2));
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .nav{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding: 14px 0; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:0.2px; }
    .logo{
      width: 34px; height: 34px; border-radius: 12px; background: linear-gradient(135deg, var(--brand), var(--brand-2));
      box-shadow: var(--shadow);
    }
    .nav-actions{ display:flex; gap:10px; align-items:center; }

    .btn{
      appearance:none; border:none; cursor:pointer; color: var(--text); font-weight: 700;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      padding: 10px 14px; border-radius: 12px; box-shadow: var(--shadow); transition: transform .06s ease, filter .2s;
    }
    .btn.secondary{ background: var(--panel-2); font-weight:600; box-shadow: none; border:1px solid rgba(255,255,255,0.1); }
    .btn.ghost{ background: transparent; border:1px solid rgba(255,255,255,0.18); box-shadow:none; }
    .btn:active{ transform: translateY(1px) scale(0.99); }
    .btn[disabled]{ opacity: .5; cursor:not-allowed; }

    .tag{ font-size: 12px; padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.15); }

    .grid{ display:grid; gap:16px; }
    @media (min-width: 900px){ .grid.cols-2{ grid-template-columns: 1fr 1fr; } }

    .card{ background: var(--panel); border:1px solid rgba(255,255,255,0.12); border-radius: 18px; padding: 16px; box-shadow: var(--shadow); }
    .card h3{ margin:6px 0 8px; }
    .muted{ color: var(--muted); opacity:.9; }

    input, select{ width: 100%; padding: 12px 12px; border-radius: 12px; border:1px solid rgba(255,255,255,0.14); background: rgba(0,0,0,0.2); color: var(--text); outline: none; font-size:16px; }
    input::placeholder{ color: #b8c0ff; opacity:.7; }
    label{ font-size: 13px; opacity:.9; }

    .row{ display:flex; gap:12px; align-items:center; flex-wrap: wrap; }

    .list{ display:flex; flex-direction:column; gap:12px; }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 12px; border-radius: 14px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); }
    .item .title{ font-weight:700; }

    .hidden{ display:none !important; }

    .pill{ display:inline-flex; align-items:center; gap:8px; padding: 8px 12px; border-radius: 999px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); }

    .switch{ position:relative; display:inline-block; width: 48px; height: 26px; }
    .switch input{ display:none; }
    .slider{ position:absolute; cursor:pointer; inset:0; background: rgba(255,255,255,0.2); transition:.2s; border-radius: 999px; }
    .slider:before{ content:""; position:absolute; height: 22px; width: 22px; left: 2px; top: 2px; background: white; border-radius: 50%; transition:.2s; }
    .switch input:checked + .slider{ background: linear-gradient(135deg, var(--brand), var(--brand-2)); }
    .switch input:checked + .slider:before{ transform: translateX(22px); }

    .progress{ height: 10px; border-radius: 999px; background: rgba(255,255,255,0.12); overflow: hidden; }
    .progress > span{ display:block; height: 100%; background: linear-gradient(90deg, var(--brand), var(--brand-2)); width:0%; transition: width .25s ease; }

    .toast{ position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color:#fff; padding: 10px 14px; border-radius: 12px; z-index: 20; box-shadow: var(--shadow); }

    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-weight:700; letter-spacing: .2px; background: rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 6px; }

    .blink{ animation: blink 1s step-start 3; }
    @keyframes blink { 50% { opacity: 0.5; } }

    .result-badge{ padding:4px 8px; border-radius:8px; font-size:12px; font-weight:800; }
    .ok{ background: rgba(46, 204, 113, .18); border:1px solid rgba(46, 204, 113, .35); }
    .err{ background: rgba(231, 76, 60, .18); border:1px solid rgba(231, 76, 60, .35); }
    .skip{ background: rgba(241, 196, 15, .18); border:1px solid rgba(241, 196, 15, .35); }

    /* --- Handwriting canvas --- */
    .ink-wrap{ display:flex; flex-direction:column; gap:8px; flex:1; }
    #inkCanvas{
      width:100%; height:180px; background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12); border-radius:12px; touch-action: none;
    }
    .ink-toolbar{ display:flex; gap:8px; align-items:center; }
    .ink-note{ font-size:12px; opacity:.85; }

    @media (max-width: 420px){
      .nav{ padding: 10px 0; }
      .brand div:first-child{ font-size:16px; }
      h2{ font-size: 20px; }
      h3{ font-size: 16px; }
      .btn{ padding: 9px 12px; border-radius: 10px; }
      .item{ padding: 10px; }
      .pill{ padding: 6px 10px; }
      .card{ padding: 12px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div style="font-size:18px; line-height:1;">听写 · Tingxie</div>
          <div style="font-size:12px; opacity:.8;">Dictation app</div>
        </div>
      </div>
      <div class="nav-actions">
        <button class="btn secondary" id="homeBtn">Home</button>
        <button class="btn secondary" id="openSettingsBtn" title="Speech & options">Settings</button>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- SCREEN: HOME / SOURCES -->
    <section id="screen-home" class="grid cols-2">
      <div class="card">
        <h2>Choose where to load your exercises</h2>
        <p class="muted">You can browse a <b>Built-in Library</b> or paste a <b>Custom Exercise</b> sheet ID.</p>
        <div class="grid cols-2">
          <div class="card" style="min-height:220px;">
            <h3>Built-in Library</h3>
            <p class="muted">Pick from the built-in list.</p>
            <div class="row">
              <button class="btn ghost" id="reloadMasterBtn" title="Refresh" aria-label="Refresh">↻</button>
            </div>
            <label for="masterSelect" style="margin-top:8px; display:block;">Built-in sheets</label>
            <select id="masterSelect"></select>
            <div class="row" style="margin-top:8px;">
              <button class="btn" id="openMasterBtn" disabled>Open Selected</button>
            </div>
            
          </div>

          <div class="card" style="min-height:220px;">
            <h3>Custom Exercise</h3>
            <p class="muted">Paste a <b>Custom Sheet ID</b>.</p>
            <label for="customId">Custom Sheet ID</label>
            <input id="customId" type="text" placeholder="e.g. 1A2bC3dE4F..." autocomplete="off"/>
            <div class="row" style="margin-top:8px;">
              <button class="btn" id="loadCustomBtn">Load Exercise Sheet</button>
            </div>
            <div id="customList" class="list" style="margin-top:10px; max-height:260px; overflow:auto;"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>How to start</h2>
        <ul class="muted" style="line-height:1.7; padding-left: 18px;">
          <li>Pick from the <b>Built-in Library</b> or paste a <b>Custom Exercise</b> Spreadsheet ID.</li>
          <li>Select an <b>exercise</b> and press <b>Start</b>.</li>
          <li>Listen, type your answer, and use <b>Try again</b> / <b>Skip</b> / <b>Show answer</b>.</li>
          <li>View your <b>summary</b> at the end.</li>
        </ul>
        <div class="row" style="margin-top:10px;">
          <span class="pill">Tip: Press <span class="kbd">Enter</span> to submit</span>
        </div>
      </div>
    </section>

    <!-- SCREEN: EXERCISE PICKER -->
    <section id="screen-picker" class="card hidden">
      <div class="row" style="justify-content:space-between;">
        <h2 id="pickerTitle">Exercises</h2>
        <div class="row">
          <button class="btn secondary" id="backHomeBtn">Back</button>
        </div>
      </div>
      <div id="exerciseList" class="list" style="margin-top:10px;"></div>
    </section>

    <!-- SCREEN: CONFIRM START -->
    <section id="screen-confirm" class="card hidden">
      <h2>Confirm Start</h2>
      <p class="muted" style="margin-top:8px;">You have selected the following exercise. Ready to begin?</p>
      <div class="card" style="margin: 12px 0;">
        <h3 id="confirmTitle" style="text-align:center; margin:0;">[Exercise Title]</h3>
      </div>
      <div class="row" style="justify-content:center; gap:16px; margin-bottom: 16px; flex-wrap:wrap;">
         <label class="pill" title="Randomize order when starting">
            <span>Randomize:</span>
            <label class="switch" style="margin-left:8px;">
              <input type="checkbox" id="randomizeToggle" />
              <span class="slider"></span>
            </label>
          </label>

          <!-- NEW: Input mode toggle -->
          <label class="pill" title="Choose Typing or Handwriting input">
            <span>Input: <b id="inputModeLabel">Typing</b></span>
            <label class="switch" style="margin-left:8px;">
              <input type="checkbox" id="inputModeToggle" />
              <span class="slider"></span>
            </label>
          </label>
      </div>
      <div class="row" style="justify-content:space-between;">
        <button class="btn secondary" id="confirmBackBtn">Back to List</button>
        <button class="btn" id="confirmStartBtn">Start Now</button>
      </div>
    </section>

    <!-- SCREEN: RUN -->
    <section id="screen-run" class="card hidden">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <h2 id="runTitle">Exercise</h2>
          <div class="muted" id="runMeta"></div>
        </div>
        <div class="row">
          <button class="btn secondary" id="stopBtn">Stop</button>
        </div>
      </div>

      <div style="margin:12px 0;" class="progress" aria-label="Progress">
        <span id="progressBar" style="width:0%"></span>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div>
            <div class="muted" style="font-size:13px;">Word <span id="idxNow">1</span> / <span id="idxTotal">1</span></div>
            <div style="font-size:22px; font-weight:800;" id="promptWord">(playing…)</div>
          </div>
        </div>

        <!-- Typing input row (unchanged) -->
        <div id="typingRow" style="margin-top:10px;" class="row">
          <input id="answerInput" type="text" placeholder="Type what you hear…" autocomplete="off" style="flex: 1;" />
          <button class="btn" id="playBtn" title="Play again">▶️ Play</button>
          <button class="btn" id="submitBtn">Submit</button>
        </div>

        <!-- Handwriting input row (new) -->
        <div id="handwritingRow" class="hidden" style="margin-top:10px;">
          <div class="ink-wrap">
            <canvas id="inkCanvas" aria-label="Handwriting canvas"></canvas>
            <div class="ink-toolbar">
              <button class="btn secondary" id="inkUndoBtn" type="button">Undo</button>
              <button class="btn secondary" id="inkClearBtn" type="button">Clear</button>
              <button class="btn" id="inkRecognizeBtn" type="button">Recognize</button>
              <div class="ink-note muted">Write clearly, then Recognize or type below.</div>
            </div>
            <div class="row">
              <input id="inkText" type="text" placeholder="Recognized or type the text…" autocomplete="off" style="flex:1;" />
              <button class="btn" id="playBtn2" title="Play again (handwriting)">▶️ Play</button>
              <button class="btn" id="submitBtn2">Submit</button>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <button class="btn secondary" id="tryAgainBtn">Try again</button>
          <button class="btn secondary" id="skipBtn">Skip</button>
          <button class="btn secondary" id="showBtn">Show answer</button>
        </div>
        <div id="feedback" class="muted" style="margin-top:8px;"></div>
      </div>

      <details id="settingsPanel" style="margin-top:12px;">
        <summary class="pill">Speech & Input Settings</summary>
        <div class="grid cols-2" style="margin-top:8px;">
          <div class="card">
            <h3>Voices</h3>
            <p class="muted">Auto-detect language. Pick preferred voices for English and Chinese.</p>
            <label>English Voice
              <select id="enVoice"></select>
            </label>
            <div class="row" style="margin-top:6px;">
              <button class="btn secondary" id="testEN">Test EN</button>
            </div>
            <div style="height:12px;"></div>
            <label>中文语音
              <select id="zhVoice"></select>
            </label>
            <div class="row" style="margin-top:6px;">
              <button class="btn secondary" id="testZH">测试中文</button>
            </div>
          </div>
          <div class="card">
            <h3>Speech Options</h3>
            <label>Rate (0.5–1.5)
              <input id="rate" type="range" min="0.5" max="1.5" step="0.05" value="1" />
            </label>
            <div style="height:8px;"></div>
            <label>Pitch (0.5–1.5)
              <input id="pitch" type="range" min="0.5" max="1.5" step="0.05" value="1" />
            </label>
            <div style="height:8px;"></div>
            <label>
              <span>Auto-play next word</span>
              <label class="switch" style="margin-left:8px;">
                <input type="checkbox" id="autoplayToggle" checked />
                <span class="slider"></span>
              </label>
            </label>
          </div>
        </div>
      </details>
    </section>

    <!-- SCREEN: SUMMARY -->
    <section id="screen-summary" class="card hidden">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <h2>Summary</h2>
          <div class="muted" id="summaryTitle"></div>
        </div>
        <div class="row">
          <button class="btn secondary" id="backToPicker">Back to exercises</button>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:10px;">
        <div class="card">
          <h3>Stats</h3>
          <div class="row" style="gap:16px; flex-wrap:wrap;">
            <div class="pill">Words: <b id="sumTotal">0</b></div>
            <div class="pill">Correct: <b id="sumCorrect">0</b></div>
            <div class="pill">Skipped: <b id="sumSkipped">0</b></div>
            <div class="pill">Accuracy: <b id="sumAcc">0%</b></div>
            <div class="pill">Time: <b id="sumTime">0s</b></div>
          </div>
        </div>
        <div class="card">
          <h3>What needs practice</h3>
          <div id="reviewList" class="list"></div>
        </div>
      </div>
      <div class="card" style="margin-top:10px;">
        <h3>All results</h3>
        <div id="resultsTable" class="list"></div>
      </div>
    </section>

    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

    <!-- SETTINGS MODAL (simple) -->
    <dialog id="settingsModal" style="border:none; border-radius:16px; background: rgba(20,22,45,0.95); color:var(--text); width:min(720px, 92vw);">
      <form method="dialog" style="margin:0;">
        <div class="card" style="box-shadow:none; background:transparent; border:none;">
          <div class="row" style="justify-content:space-between;">
            <h2>App Settings</h2>
            <button class="btn secondary" value="close">Close</button>
          </div>
          <div class="grid cols-2" style="margin-top:8px;">
            <div class="card">
              <h3>Voices</h3>
              <label>English Voice
                <select id="enVoice2"></select>
              </label>
              <div style="height:6px;"></div>
              <label>中文语音
                <select id="zhVoice2"></select>
              </label>
              <div class="row" style="margin-top:6px;">
                <button class="btn secondary" id="testEN2">Test EN</button>
                <button class="btn secondary" id="testZH2">测试中文</button>
              </div>
            </div>
            <div class="card">
              <h3>Speech</h3>
              <label>Rate
                <input id="rate2" type="range" min="0.5" max="1.5" step="0.05" value="1" />
              </label>
              <div style="height:8px;"></div>
              <label>Pitch
                <input id="pitch2" type="range" min="0.5" max="1.5" step="0.05" value="1" />
              </label>
            </div>
          </div>
        </div>
      </form>
    </dialog>
  </main>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
  // ======= CONFIG =======
  const MASTER_SPREADSHEET_ID = "1ee1TP1rHK47sESfpuuqA0MyBae5NczxEO7hCYB0_xD8"; // <-- Replace with your master sheet ID (title, sheet id)

  // ======= STATE =======
  const state = {
    ttsReady: false,
    voices: [],
    selected: { en: null, zh: null, rate: 1, pitch: 1 },
    source: null, // {type:'master'|'custom', id}
    picker: [], // list of {label, id} for master OR list of exercises for custom
    exerciseSheet: null, // current sheet object
    exerciseRows: [], // [{title, words:[...]}]
    prefs: { inputMode: 'typing' }, // NEW: 'typing' | 'handwriting'
    current: {
      title: '',
      words: [],
      order: [],
      i: 0,
      startedAt: 0,
      perWordStart: 0,
      selectedIndex: -1,
      results: [] // [{word, correct, attempts, skipped, shownAnswer, timeMs}]
    },
    ink: { paths: [], drawing: false, dpr: 1 }
  };

  // ======= HELPERS =======
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  function toast(msg, ms=1800){
    const t = $('#toast'); t.textContent = msg; t.classList.remove('hidden');
    setTimeout(()=> t.classList.add('hidden'), ms);
  }

  function savePrefs(){
    localStorage.setItem('tingxie_prefs', JSON.stringify({
      en: state.selected.en?.name || null,
      zh: state.selected.zh?.name || null,
      rate: state.selected.rate,
      pitch: state.selected.pitch,
      randomize: $('#randomizeToggle').checked,
      autoplay: $('#autoplayToggle').checked,
      lastCustom: $('#customId').value || '',
      inputMode: state.prefs.inputMode || 'typing' // NEW
    }));
  }
  function loadPrefs(){
    try{
      const p = JSON.parse(localStorage.getItem('tingxie_prefs')||'{}');
      if(p.rate) state.selected.rate = p.rate;
      if(p.pitch) state.selected.pitch = p.pitch;
      if(p.randomize!=null) $('#randomizeToggle').checked = p.randomize;
      if(p.autoplay!=null) $('#autoplayToggle').checked = p.autoplay;
      if(p.lastCustom) $('#customId').value = p.lastCustom;
      if(p.inputMode) state.prefs.inputMode = p.inputMode; // NEW
      // voice names resolved after voices load
    }catch{}
    const t = $('#inputModeToggle'); const l = $('#inputModeLabel');
    if(t && l){ t.checked = (state.prefs.inputMode === 'handwriting'); l.textContent = t.checked ? 'Handwriting' : 'Typing'; }
  }

  function csvParse(text){
    const lines = text.replace(/\r\n?/g, "\n").split("\n").filter(l=>l.trim().length>0);
    const rows = lines.map(line => line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(cell => {
      let c = cell.trim();
      if(c.startsWith('"') && c.endsWith('"')) c = c.slice(1,-1).replace(/""/g,'"');
      return c;
    }));
    return rows;
  }

  function normalizeHeader(h){ return h.trim().toLowerCase().replace(/\s+/g,' '); }

  function getCsvUrl(spreadsheetId){
    return `https://docs.google.com/spreadsheets/d/${encodeURIComponent(spreadsheetId)}/export?format=csv`;
  }

  async function fetchSheetCsv(spreadsheetId){
    const url = getCsvUrl(spreadsheetId);
    const res = await fetch(url);
    if(!res.ok) throw new Error(`Failed to load CSV (${res.status})`);
    return await res.text();
  }

  function isChinese(str){ return /[\p{Script=Han}]/u.test(str); }

  function splitWords(raw){
    if(!raw) return [];
    return raw
      .split(/[，,]/g)
      .map(s=>s.replace(/\s+/g,' ').trim())
      .filter(Boolean);
  }

  function normEnglish(s){
    return (s||'').toLocaleLowerCase().normalize('NFC').replace(/[^\p{Letter}\p{Number}]+/gu,'');
  }
  function normChinese(s){
    return (s||'').normalize('NFC').replace(/\s+/g,'');
  }
  function isCorrect(expected, input){
    if(isChinese(expected)){
      return normChinese(expected) === normChinese(input);
    } else {
      return normEnglish(expected) === normEnglish(input);
    }
  }

  function fmtMs(ms){
    const s = Math.round(ms/1000);
    if(s < 60) return s+"s";
    const mm = Math.floor(s/60), ss = s%60;
    return `${mm}m ${ss}s`;
  }

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }

  // ======= TTS =======
  function loadVoices(){
    let list = speechSynthesis.getVoices();
    if(list.length){ onVoices(list); }
  }

  function onVoices(list){
    state.ttsReady = true; state.voices = list.slice().sort((a,b)=>a.lang.localeCompare(b.lang) || a.name.localeCompare(b.name));
    
    const en = state.voices.filter(v=>/^en[-_]/i.test(v.lang));
    const zh = state.voices.filter(v=>/^zh[-_]/i.test(v.lang));

    function fill(select, voices){
      select.innerHTML = voices.map(v=>`<option value="${encodeURIComponent(v.name)}">${v.name} · ${v.lang}</option>`).join('');
    }

    [$('#enVoice'), $('#enVoice2')].forEach(sel=> fill(sel, en));
    [$('#zhVoice'), $('#zhVoice2')].forEach(sel=> fill(sel, zh));

    const prefs = JSON.parse(localStorage.getItem('tingxie_prefs')||'{}');
    if(prefs.en){ const v = state.voices.find(v=>v.name===prefs.en); if(v){ state.selected.en=v; [$('#enVoice'),$('#enVoice2')].forEach(s=>s.value=encodeURIComponent(v.name)); } }
    if(prefs.zh){ const v = state.voices.find(v=>v.name===prefs.zh); if(v){ state.selected.zh=v; [$('#zhVoice'),$('#zhVoice2')].forEach(s=>s.value=encodeURIComponent(v.name)); } }

    if(!state.selected.en && en[0]){ state.selected.en = en[0]; [$('#enVoice'),$('#enVoice2')].forEach(s=>s.value=encodeURIComponent(en[0].name)); }
    if(!state.selected.zh && zh[0]){ state.selected.zh = zh[0]; [$('#zhVoice'),$('#zhVoice2')].forEach(s=>s.value=encodeURIComponent(zh[0].name)); }
  }

  function getVoiceForWord(word){
    const zh = isChinese(word);
    const preferred = zh ? state.selected.zh : state.selected.en;
    if(preferred) return preferred;
    const list = zh ? state.voices.filter(v=>/^zh/i.test(v.lang)) : state.voices.filter(v=>/^en/i.test(v.lang));
    return list[0] || state.voices[0] || null;
  }

  function speak(text){
    if(!('speechSynthesis' in window)) { toast('Speech Synthesis not supported in this browser.'); return; }
    const voice = getVoiceForWord(text);
    const u = new SpeechSynthesisUtterance(text);
    if(voice){ u.voice = voice; u.lang = voice.lang; }
    u.rate = state.selected.rate; u.pitch = state.selected.pitch;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // ======= UI FLOW =======
  function show(id){
    ['#screen-home', '#screen-picker', '#screen-confirm', '#screen-run', '#screen-summary'].forEach(sel=> $(sel).classList.add('hidden'));
    $(id).classList.remove('hidden');
  }

  function buildMasterList(rows){
    const sel = $('#masterSelect');
    const openBtn = $('#openMasterBtn');
    if(sel){
      sel.innerHTML = '';
      const ph = document.createElement('option');
      ph.value = ''; ph.textContent = '— Select —'; ph.disabled = true; ph.selected = true;
      sel.appendChild(ph);
    }
    if(!rows.length){
      if(sel){ sel.innerHTML = '<option value="" disabled selected>No items</option>'; }
      if(openBtn){ openBtn.disabled = true; }
      return;
    }
    rows.forEach(r=>{
      if(sel){ const opt = document.createElement('option'); opt.value = r.id; opt.textContent = r.title; sel.appendChild(opt); }
    });
    if(openBtn){ openBtn.disabled = false; }
  }

  function tryAgain(){
    $('#answerInput').value='';
    $('#inkText') && ($('#inkText').value='');
    clearInk();
    $('#answerInput').focus();
    $('#feedback').textContent='';
  }

  function skipWord(){
    const expected = currentWord();
    const timeMs = performance.now() - state.current.perWordStart;
    state.current.results.push({word: expected, correct: false, attempts: '—', skipped: true, shownAnswer: false, timeMs});
    $('#feedback').innerHTML = `<span class=\"result-badge skip\">Skipped</span> It was: <b>${expected}</b>`;
    nextWord();
  }

  function showAnswer(){
    const expected = currentWord();
    const timeMs = performance.now() - state.current.perWordStart;
    state.current.results.push({word: expected, correct: false, attempts: '—', skipped: false, shownAnswer: true, timeMs});
    $('#feedback').innerHTML = `Answer: <b>${expected}</b>`;
    nextWord();
  }

  function nextWord(){
    const {words} = state.current;
    $('#answerInput').value='';
    $('#inkText') && ($('#inkText').value='');
    clearInk();
    state.current.i++;
    state.current.perWordStart = 0;
    updateProgress();
    if(state.current.i >= words.length){
      finishExercise();
    } else {
      if($('#autoplayToggle').checked){ setTimeout(playCurrent, 350); }
      else { $('#promptWord').textContent = '(ready)'; }
    }
  }

  function finishExercise(){
    $('#progressBar').style.width = '100%';
    const totalMs = performance.now() - state.current.startedAt;

    const total = state.current.words.length;
    const correct = state.current.results.filter(r=>r.correct).length;
    const skipped = state.current.results.filter(r=>r.skipped).length;
    const accuracy = total ? Math.round((correct/total)*100) : 0;

    $('#summaryTitle').textContent = state.current.title;
    $('#sumTotal').textContent = total;
    $('#sumCorrect').textContent = correct;
    $('#sumSkipped').textContent = skipped;
    $('#sumAcc').textContent = accuracy + '%';
    $('#sumTime').textContent = fmtMs(totalMs);

    const review = $('#reviewList'); review.innerHTML='';
    state.current.results.filter(r=>!r.correct).forEach(r=>{
      const d = document.createElement('div'); d.className='item';
      d.innerHTML = `<div><div class=\"title\">${r.word}</div><div class=\"muted\">${r.skipped? 'skipped' : r.shownAnswer? 'gave up' : 'incorrect'}</div></div>`;
      const btn = document.createElement('button'); btn.className='btn secondary'; btn.textContent='Practice';
      btn.onclick = ()=> speak(r.word);
      d.appendChild(btn); review.appendChild(d);
    });

    const table = $('#resultsTable'); table.innerHTML='';
    state.current.results.forEach((r,idx)=>{
      const d = document.createElement('div'); d.className='item';
      const badge = r.correct? '<span class=\"result-badge ok\">✓</span>' : (r.skipped? '<span class=\"result-badge skip\">⏭</span>' : '<span class=\"result-badge err\">✗</span>');
      d.innerHTML = `<div><div class=\"title\">${idx+1}. ${r.word}</div><div class=\"muted\">${badge} ${r.correct? 'correct' : r.skipped? 'skipped' : r.shownAnswer? 'gave up' : 'wrong'}, time: ${fmtMs(r.timeMs)}</div></div>`;
      table.appendChild(d);
    });

    show('#screen-summary');
  }

  function buildExercisePicker(items, sourceLabel='Built-in'){
    state.exerciseRows = items;
    $('#pickerTitle').textContent = `${sourceLabel} — Exercises`;
    const list = $('#exerciseList'); list.innerHTML='';
    items.forEach((it, idx)=>{
      const d = document.createElement('div'); d.className='item';
      d.innerHTML = `<div><div class="title">${it.title||('Exercise '+(idx+1))}</div><div class="muted">${it.words.length} words</div></div>`;
      const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Start';
      btn.onclick = ()=> showConfirmScreen(idx);
      d.appendChild(btn); list.appendChild(d);
    });
    show('#screen-picker');
  }

  function showConfirmScreen(idx){
    const ex = state.exerciseRows[idx];
    if(!ex) return;
    state.current.selectedIndex = idx;
    $('#confirmTitle').textContent = ex.title || 'Exercise';
    const t = $('#inputModeToggle'); const l = $('#inputModeLabel');
    t.checked = (state.prefs.inputMode === 'handwriting');
    l.textContent = t.checked ? 'Handwriting' : 'Typing';
    show('#screen-confirm');
  }

  function startExercise(idx){
    const ex = state.exerciseRows[idx]; if(!ex) return;
    state.current.title = ex.title || 'Exercise';
    state.current.words = ex.words.slice();
    state.current.order = state.current.words.map((_,i)=>i);
    if($('#randomizeToggle').checked) state.current.order = shuffle(state.current.order);
    state.current.i = 0; state.current.results = []; state.current.startedAt = performance.now();
    state.current.perWordStart = 0; state.current.attemptsForWord = 0;
    $('#runTitle').textContent = state.current.title;
    $('#runMeta').textContent = `${state.current.words.length} words`;
    $('#promptWord').textContent = '(Press Play to begin)';
    $('#idxTotal').textContent = state.current.words.length;
    $('#answerInput').value=''; $('#feedback').textContent='';

    if(state.prefs.inputMode === 'handwriting'){
      $('#typingRow').classList.add('hidden');
      $('#handwritingRow').classList.remove('hidden');
      setupInkCanvas(); clearInk(); $('#inkText').value='';
    } else {
      $('#handwritingRow').classList.add('hidden');
      $('#typingRow').classList.remove('hidden');
    }

    show('#screen-run');
    updateProgress();
  }

  function currentWord(){
    const {words, order, i} = state.current; const idx = (order && order[i] != null) ? order[i] : i; return words[idx] || '';
  }

  function playCurrent(){
    if (state.current.perWordStart === 0) {
      state.current.perWordStart = performance.now();
      state.current.attemptsForWord = 0;
    }
    const w = currentWord();
    $('#promptWord').textContent = '(playing…)';
    if(w) speak(w);
    (state.prefs.inputMode === 'handwriting' ? $('#inkText') : $('#answerInput')).focus();
  }

  function updateProgress(){
    const i = state.current.i; const total = state.current.words.length;
    $('#idxNow').textContent = Math.min(i+1, total);
    $('#idxTotal').textContent = total;
    const pct = total ? Math.round((i/total)*100) : 0;
    $('#progressBar').style.width = pct + '%';
  }

  function getUserInput(){
    if(state.prefs.inputMode === 'handwriting'){
      return ($('#inkText')?.value || '').trim();
    } else {
      return ($('#answerInput')?.value || '').trim();
    }
  }

  function submitAnswer(){
    const input = getUserInput();
    const expected = currentWord();
    if(!expected) return;
    const timeMs = performance.now() - state.current.perWordStart;
    state.current.attemptsForWord = (state.current.attemptsForWord||0) + 1;
    if(isCorrect(expected, input)){
      state.current.results.push({word: expected, correct: true, attempts: state.current.attemptsForWord, skipped: false, shownAnswer: false, timeMs});
      $('#feedback').innerHTML = '<span class="result-badge ok">Correct</span>';
      nextWord();
    } else {
      $('#feedback').innerHTML = `<span class=\"result-badge err\">Wrong</span> Try again, or <b>Skip</b> / <b>Show answer</b>.`;
      const tgt = (state.prefs.inputMode === 'handwriting' ? $('#inkText') : $('#answerInput'));
      tgt.classList.add('blink'); setTimeout(()=> tgt.classList.remove('blink'), 800);
      tgt.focus();
    }
  }

  // ======= LOADERS =======
  async function loadMaster(){
    const card = document.querySelector('#masterSelect')?.closest('.card');
    try{
      if(!MASTER_SPREADSHEET_ID || MASTER_SPREADSHEET_ID === 'xxxxx'){
        if(card) card.style.display='none';
        return;
      }
      if(card) card.style.display='';
      
      const csv = await fetchSheetCsv(MASTER_SPREADSHEET_ID);
      const rows = csvParse(csv).filter(r=> (r||[]).some(c=> String(c||'').trim() !== ''));
      if(!rows.length) throw new Error('Empty sheet');

      const data = rows.slice(1).map(r=>{
        const title = (r[0]||'').toString().trim();
        let id = (r[1]||'').toString().trim();
        const m = id.match(/\/d\/([A-Za-z0-9-_]+)/); if(m) id = m[1];
        return { title, id };
      }).filter(x=> x.title && x.id);

      buildMasterList(data);
    }catch(err){
      console.warn('Master load failed:', err.message);
      if(card) card.style.display='none';
    }
  }

  async function loadExerciseSheet(sheetId, sourceLabel='Custom'){
    try{
      show('#screen-home');
      $('#customList').innerHTML = '';
      $('#exerciseList').innerHTML = '';
      const csv = await fetchSheetCsv(sheetId);
      const rows = csvParse(csv);
      if(!rows.length) throw new Error('Empty sheet');
      const headers = rows[0].map(normalizeHeader);
      const iTitle = headers.indexOf('title');
      const iWords = headers.indexOf('words');
      if(iTitle < 0 || iWords < 0) throw new Error('Exercise sheet must have headers: title, words');
      const items = rows.slice(1).filter(r=>r[iTitle] || r[iWords]).map(r=>({
        title: (r[iTitle]||'').trim(),
        words: splitWords(r[iWords])
      })).filter(x=>x.words.length>0);
      if(!items.length) throw new Error('No exercises found');
      buildExercisePicker(items, sourceLabel);
      state.source = {type:'custom', id: sheetId};
      savePrefs();
    }catch(err){
      console.error(err); toast('Failed to load exercise sheet: ' + err.message, 2600);
    }
  }

  // ======= HANDWRITING (ink) =======
  function setupInkCanvas(){
    const canvas = $('#inkCanvas'); if(!canvas) return;
    const dpr = window.devicePixelRatio || 1; state.ink.dpr = dpr;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    drawInk();

    const toXY = (e)=>{
      const r = canvas.getBoundingClientRect();
      const p = ('touches' in e && e.touches[0]) ? e.touches[0] : e;
      return { x: (p.clientX - r.left), y: (p.clientY - r.top) };
    };

    const start = (e)=>{ e.preventDefault(); const {x,y} = toXY(e); state.ink.drawing = true; state.ink.paths.push([{x,y}]); drawInk(); };
    const move = (e)=>{ if(!state.ink.drawing) return; const {x,y} = toXY(e); const path = state.ink.paths[state.ink.paths.length-1]; path.push({x,y}); drawInk(); };
    const end = ()=>{ state.ink.drawing = false; };

    canvas.onpointerdown = start; canvas.onpointermove = move; canvas.onpointerup = end; canvas.onpointerleave = end;
    canvas.ontouchstart = start; canvas.ontouchmove = move; canvas.ontouchend = end;
    window.addEventListener('resize', ()=> setupInkCanvas(), { once:true });
  }

  function drawInk(){
    const canvas = $('#inkCanvas'); if(!canvas) return;
    const ctx = canvas.getContext('2d');
    ctx.save();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.restore();

    ctx.save();
    ctx.scale(state.ink.dpr, state.ink.dpr);
    ctx.lineWidth = 3;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#fff'; // white strokes on dark UI
    for(const path of state.ink.paths){
      if(path.length < 2) continue;
      ctx.beginPath();
      ctx.moveTo(path[0].x, path[0].y);
      for(let i=1;i<path.length;i++){ ctx.lineTo(path[i].x, path[i].y); }
      ctx.stroke();
    }
    ctx.restore();
  }

  function clearInk(){ state.ink.paths = []; drawInk(); }
  function undoInk(){ state.ink.paths.pop(); drawInk(); }

  // Build a white background + black ink PNG for OCR
  function inkDataUrlForOCR(){
    const view = $('#inkCanvas'); if(!view) return null;
    const rect = view.getBoundingClientRect();

    // Use CSS pixel size for clarity
    const w = Math.max(1, Math.floor(rect.width));
    const h = Math.max(1, Math.floor(rect.height));
    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    const ctx = c.getContext('2d');

    // white background
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,w,h);

    // redraw paths in black (paths are stored in CSS px)
    ctx.lineWidth = 3;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
    for(const path of state.ink.paths){
      if(!path || path.length < 2) continue;
      ctx.beginPath();
      ctx.moveTo(path[0].x, path[0].y);
      for(let i=1;i<path.length;i++){ ctx.lineTo(path[i].x, path[i].y); }
      ctx.stroke();
    }

    return c.toDataURL('image/png');
  }

  async function recognizeInk(){
    try{
      if(!window.Tesseract){ toast('OCR library not loaded'); return; }
      const dataUrl = inkDataUrlForOCR();
      if(!dataUrl){ toast('Canvas not ready'); return; }
      if((state.ink.paths||[]).length === 0){ toast('Write something first 🙂'); return; }

      toast('Recognizing…');
      // Prefer simplified Chinese + English; you can switch to 'eng+chi_tra'
      const { data: { text } } = await Tesseract.recognize(
        dataUrl,
        'eng+chi_sim',
        {
          // logger: m => console.log(m), // uncomment for progress logs
        }
      );
      const out = (text||'').trim();
      if(out){
        $('#inkText').value = out.replace(/\s+/g, isChinese(out) ? '' : ' ').trim();
        toast('Recognition complete — check & submit');
      }else{
        toast('No text recognized. Try writing larger/clearer.');
      }
    }catch(err){
      console.error(err);
      toast('Recognition failed: ' + (err?.message || err));
    }
  }

  // ======= EVENTS =======
  function bindEvents(){
    const stopAndReset = (screen) => {
      if('speechSynthesis' in window) speechSynthesis.cancel();
      state.current.selectedIndex = -1;
      show(screen);
    };

    // Master reload
    $('#reloadMasterBtn')?.addEventListener('click', loadMaster);

    const _selMaster = $('#masterSelect'); if(_selMaster){ _selMaster.addEventListener('change', ()=> { $('#openMasterBtn').disabled = !_selMaster.value; }); }

    $('#openMasterBtn')?.addEventListener('click', ()=>{ 
      const sel = $('#masterSelect');
      const id = sel?.value;
      const title = sel?.options?.[sel.selectedIndex]?.textContent || 'Built-in';
      if(!id){ toast('Choose from the Built-in list'); return; }
      loadExerciseSheet(id, title);
    });

    $('#loadCustomBtn').addEventListener('click', ()=>{
      const id = $('#customId').value.trim(); if(!id) return toast('Paste a Spreadsheet ID');
      loadExerciseSheet(id, 'Custom');
    });

    $('#homeBtn').addEventListener('click', ()=> stopAndReset('#screen-home'));
    $('#backHomeBtn').addEventListener('click', ()=> stopAndReset('#screen-home'));

    // Confirm screen buttons
    $('#confirmStartBtn').addEventListener('click', () => {
      if (state.current.selectedIndex > -1) {
        startExercise(state.current.selectedIndex);
      }
    });
    $('#confirmBackBtn').addEventListener('click', () => show('#screen-picker'));

    // Input mode toggle
    const modeToggle = $('#inputModeToggle');
    const modeLabel = $('#inputModeLabel');
    modeToggle.addEventListener('change', ()=>{
      state.prefs.inputMode = modeToggle.checked ? 'handwriting' : 'typing';
      modeLabel.textContent = modeToggle.checked ? 'Handwriting' : 'Typing';
      savePrefs();
    });

    // Run screen
    $('#playBtn').addEventListener('click', playCurrent);
    $('#submitBtn').addEventListener('click', submitAnswer);
    $('#tryAgainBtn').addEventListener('click', tryAgain);
    $('#skipBtn').addEventListener('click', skipWord);
    $('#showBtn').addEventListener('click', showAnswer);
    $('#stopBtn').addEventListener('click', ()=> stopAndReset('#screen-picker'));
    $('#backToPicker')?.addEventListener('click', ()=> stopAndReset('#screen-picker'));

    // Typing: Enter to submit
    $('#answerInput').addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); submitAnswer(); }
    });

    // Handwriting controls
    $('#inkUndoBtn')?.addEventListener('click', undoInk);
    $('#inkClearBtn')?.addEventListener('click', clearInk);
    $('#inkRecognizeBtn')?.addEventListener('click', recognizeInk);
    $('#submitBtn2')?.addEventListener('click', submitAnswer);
    $('#playBtn2')?.addEventListener('click', playCurrent);
    $('#inkText')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); submitAnswer(); } });

    // voice selects
    function selectByName(name){ return state.voices.find(v=>v.name===decodeURIComponent(name)); }
    $('#enVoice').addEventListener('change', (e)=>{ state.selected.en = selectByName(e.target.value); savePrefs(); });
    $('#zhVoice').addEventListener('change', (e)=>{ state.selected.zh = selectByName(e.target.value); savePrefs(); });
    $('#enVoice2').addEventListener('change', (e)=>{ state.selected.en = selectByName(e.target.value); savePrefs(); });
    $('#zhVoice2').addEventListener('change', (e)=>{ state.selected.zh = selectByName(e.target.value); savePrefs(); });

    $('#rate').addEventListener('input', (e)=>{ state.selected.rate = parseFloat(e.target.value); $('#rate2').value=e.target.value; savePrefs(); });
    $('#pitch').addEventListener('input', (e)=>{ state.selected.pitch = parseFloat(e.target.value); $('#pitch2').value=e.target.value; savePrefs(); });
    $('#rate2').addEventListener('input', (e)=>{ state.selected.rate = parseFloat(e.target.value); $('#rate').value=e.target.value; savePrefs(); });
    $('#pitch2').addEventListener('input', (e)=>{ state.selected.pitch = parseFloat(e.target.value); $('#pitch').value=e.target.value; savePrefs(); });

    $('#autoplayToggle').addEventListener('change', savePrefs);
    $('#randomizeToggle').addEventListener('change', savePrefs);

    // settings modal
    const modal = $('#settingsModal');
    $('#openSettingsBtn').addEventListener('click', ()=> modal.showModal());

    // test buttons
    function testSpeakEn(){ speak('Hello! This is the English voice test.'); }
    function testSpeakZh(){ speak('你好！这是中文语音测试。'); }
    $('#testEN').addEventListener('click', testSpeakEn);
    $('#testZH').addEventListener('click', testSpeakZh);
    $('#testEN2').addEventListener('click', testSpeakEn);
    $('#testZH2').addEventListener('click', testSpeakZh);
  }

  // ======= INIT =======
  (function init(){
    loadPrefs();
    bindEvents();

    if(!('speechSynthesis' in window)){
      toast('This browser does not support Speech Synthesis.');
    } else {
      window.speechSynthesis.onvoiceschanged = ()=> onVoices(window.speechSynthesis.getVoices());
      loadVoices();
      const temp = new SpeechSynthesisUtterance(''); speechSynthesis.speak(temp); speechSynthesis.cancel();
    }

    loadMaster();
  })();
  </script>
</body>
</html>
