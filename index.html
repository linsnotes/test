<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Book List Builder</title>

<!-- ====== Minimal, clean styling (no external CSS) ====== -->
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#1f2937; --text:#e5e7eb; --sub:#9ca3af;
    --accent:#22d3ee; --accent2:#a78bfa; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    --chip:#374151; --border:#2b3443;
  }
  html,body{height:100%}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif,
    "Apple Color Emoji","Segoe UI Emoji";background:linear-gradient(180deg,#0b1220,#0f172a 20%,#0f172a);
    color:var(--text)
  }
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:clamp(20px,2.5vw,28px);margin:0}
  .subtitle{color:var(--sub);font-size:.95rem}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  .filters{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px}
  .filters .col-span-2{grid-column:span 2}
  .filters .col-span-3{grid-column:span 3}
  .filters .col-span-6{grid-column:span 6}
  label{display:block;font-size:.85rem;color:var(--sub);margin-bottom:6px}
  select,input[type="text"]{
    width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
    background:#0b1324;color:var(--text);outline:none
  }
  input[type="checkbox"]{transform:scale(1.1);margin-right:8px}
  .btn{
    appearance:none;border:1px solid var(--border);background:#0b1324;color:var(--text);
    padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600
  }
  .btn:hover{border-color:#3a4558}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#05101a;border:none}
  .btn.ok{background:linear-gradient(90deg,var(--ok),#34d399);border:none;color:#062014}
  .btn.ghost{background:transparent}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .spacer{flex:1}
  .counter{color:var(--sub);font-size:.9rem}
  .groups{display:grid;gap:10px;margin-top:12px}
  .group{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#0b1324}
  .group>summary{
    list-style:none;cursor:default;padding:12px 14px;background:#0c1426;border-bottom:1px solid var(--border);
    display:flex;align-items:center;gap:8px;font-weight:700
  }
  .group>summary span.tag{background:var(--chip);padding:2px 8px;border-radius:999px;color:#cbd5e1;font-size:.8rem}
  .subgroup{padding:8px 12px 14px 12px}
  .subhead{font-weight:700;margin:10px 2px;color:#cbd5e1}
  ul.list{margin:8px 0 0 0;padding:0;list-style:none;display:grid;gap:6px}
  ul.list li{background:#0a1020;border:1px solid var(--border);padding:10px;border-radius:12px;display:flex;align-items:center;justify-content:space-between}
  .chips{display:flex;gap:6px;align-items:center}
  .chip{background:var(--chip);padding:2px 8px;border-radius:999px;color:#cbd5e1;font-size:.78rem;border:1px solid #2a3344}
  .chip.ok{background:#083a2b;border-color:#0f5132;color:#d1fae5}
  .empty{padding:14px;border:1px dashed var(--border);border-radius:12px;color:var(--sub);background:#0b1324}
  .two-cols{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  .sticky{position:sticky;top:8px}
  .muted{color:var(--sub)}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;border:1px solid var(--border);padding:10px 12px;border-radius:12px;opacity:0;transform:translateY(8px);transition:all .2s}
  .toast.show{opacity:1;transform:none}
  .small{font-size:.85rem}
  .input-inline{display:flex;gap:10px;align-items:center}
  .hr{height:1px;background:var(--border);margin:10px 0}
  a.help{color:var(--accent)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Book List Builder</h1>
        <div class="subtitle">Filter textbooks from a shared Google Sheet and build your personalized list.</div>
      </div>
      <div class="input-inline">
        <label for="studentName" class="small muted">Student Name</label>
        <input id="studentName" type="text" placeholder="Enter name (optional)" />
      </div>
    </header>

    <!-- ====== Filters ====== -->
    <section class="card">
      <form id="filtersForm">
        <div class="filters">
          <div>
            <label for="level">Level</label>
            <select id="level"><option value="">All</option></select>
          </div>
          <div>
            <label for="subject">Subject</label>
            <select id="subject"><option value="">All</option></select>
          </div>
          <div>
            <label for="banding">Banding</label>
            <select id="banding"><option value="">All</option></select>
          </div>
          <div class="col-span-2">
            <label for="search">Textbook keyword</label>
            <input id="search" type="text" placeholder="e.g. Textbook / Workbook / 1A / 1B" />
          </div>
          <div class="row">
            <label class="input-inline" title="Show only compulsory items">
              <input id="compOnly" type="checkbox" /> Compulsory only
            </label>
            <span class="spacer"></span>
            <button type="button" id="resetBtn" class="btn ghost">Reset</button>
            <button type="submit" class="btn primary">Apply</button>
          </div>
        </div>
      </form>
    </section>

    <!-- ====== Results + My List ====== -->
    <div class="two-cols">
      <!-- Results -->
      <section class="card">
        <div class="row" style="margin-bottom:6px">
          <div class="counter" id="resultsCounter">Loadingâ€¦</div>
          <span class="spacer"></span>
          <button id="addBtn" class="btn ok">Add current results to My List</button>
        </div>
        <div id="results" class="groups"></div>
      </section>

      <!-- My List -->
      <section class="card sticky" id="myListCard">
        <div class="row" style="margin-bottom:6px">
          <strong>My List</strong>
          <span class="spacer"></span>
          <button id="pdfBtn" class="btn primary">Download PDF</button>
          <button id="clearBtn" class="btn ghost">Clear</button>
        </div>
        <div id="myListMeta" class="small muted"></div>
        <div class="hr"></div>
        <div id="myList" class="groups"></div>
        <div id="myListEmpty" class="empty">Your list is empty. Filter on the left and click <em>Add current results to My List</em>.</div>
      </section>
    </div>

    <p class="small muted" style="margin:16px 4px">
      Data source: Google Sheet (first sheet). Replace <code>MASTER_SHEET_ID</code> in the code.
      For help, see <a class="help" href="https://support.google.com/docs/answer/9143380" target="_blank" rel="noopener">Share a sheet</a>.
    </p>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ====== Libraries (CDN). If you truly need one-file offline, download these and inline their minified code. ====== -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <!-- ====== App Logic ====== -->
  <script>
  // ---------- Configuration ----------
  const SHEET_ID = '1EM6Zy3Ii7wKoLrQt40ioyLip1RdDeqgBHKRt5aGB9l8'; // <<<<<<<<<<<<<<<<<< replace with your Google Sheet ID
  const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;

  // ---------- App State ----------
  let rawRows = [];        // array of objects from sheet
  let filtered = [];       // current filtered rows
  const myListMap = new Map(); // key -> item (deduped)
  const KEY_ORDER = ['sn','level','subject','banding','textbook','compulsory'];

  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  const showToast = (msg, kind='info') => {
    const el = $('#toast');
    el.textContent = msg;
    el.style.borderColor = kind==='ok' ? '#14532d' : (kind==='warn' ? '#6b4f16' : '#2b3443');
    el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'), 1800);
  };

  const norm = v => (v ?? '').toString().trim();
  const toBoolYes = v => /^y(es)?$/i.test(norm(v)); // YES / Yes / Y
  const nice = v => norm(v);

  function mapHeaders(headerRow){
    // Normalize headers to known keys regardless of order/case/extra spaces
    const map = {};
    headerRow.forEach((h, idx) => {
      const key = norm(h).toLowerCase();
      if (key === 'sn') map.sn = idx;
      else if (key === 'level') map.level = idx;
      else if (key === 'subject') map.subject = idx;
      else if (key === 'banding') map.banding = idx;
      else if (key === 'textbook') map.textbook = idx;
      else if (key === 'compulsory') map.compulsory = idx;
    });
    // Ensure required columns exist
    const needed = ['sn','level','subject','banding','textbook','compulsory'];
    const missing = needed.filter(k => !(k in map));
    if (missing.length){
      throw new Error('Missing required column(s): ' + missing.join(', '));
    }
    return map;
  }

  function arrayToObjects(rows2D){
    const headers = rows2D[0] || [];
    const indexMap = mapHeaders(headers);
    const out = [];
    for (let i=1;i<rows2D.length;i++){
      const r = rows2D[i] || [];
      // skip completely empty lines
      if (r.every(x => !norm(x))) continue;
      out.push({
        sn: nice(r[indexMap.sn]),
        level: nice(r[indexMap.level]),
        subject: nice(r[indexMap.subject]),
        banding: nice(r[indexMap.banding]),
        textbook: nice(r[indexMap.textbook]),
        compulsory: toBoolYes(r[indexMap.compulsory])
      });
    }
    return out;
  }

  function uniqueSorted(values){
    return [...new Set(values.filter(Boolean))].sort((a,b)=>a.localeCompare(b,'en',{numeric:true}));
  }

  function populateFilters(){
    // dependent lists
    const levelSel = $('#level'), subjectSel = $('#subject'), bandingSel = $('#banding');

    const current = {
      level: levelSel.value,
      subject: subjectSel.value,
      banding: bandingSel.value
    };

    // Build filtered pools for options
    const poolForLevel = rawRows;
    const levels = uniqueSorted(poolForLevel.map(r => r.level));
    fillSelect(levelSel, levels, current.level);

    const poolForSubject = rawRows.filter(r => !current.level || r.level === current.level);
    const subjects = uniqueSorted(poolForSubject.map(r => r.subject));
    fillSelect(subjectSel, subjects, current.subject);

    const poolForBanding = rawRows.filter(r =>
      (!current.level || r.level === current.level) &&
      (!current.subject || r.subject === current.subject)
    );
    const bandings = uniqueSorted(poolForBanding.map(r => r.banding));
    fillSelect(bandingSel, bandings, current.banding);
  }

  function fillSelect(sel, options, keepVal){
    const prev = keepVal ?? sel.value;
    const opts = ['<option value="">All</option>'].concat(options.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));
    sel.innerHTML = opts.join('');
    if (prev && options.includes(prev)) sel.value = prev;
  }

  function escapeHtml(str){
    return (str??'').toString()
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
  }

  // ---------- Fetch & Parse ----------
  async function loadSheet(){
    $('#resultsCounter').textContent = 'Loadingâ€¦';
    try{
      const resp = await fetch(CSV_URL, {cache:'no-store'});
      if (!resp.ok) throw new Error('Fetch failed, check sharing permissions.');
      const csvText = await resp.text();

      // Parse with SheetJS so we can extend to XLSX easily if needed
      const wb = XLSX.read(csvText, { type: 'string' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows2D = XLSX.utils.sheet_to_json(ws, { header:1, defval:"" });

      rawRows = arrayToObjects(rows2D);

      populateFilters();
      applyFilters(); // initial render
    }catch(err){
      console.error(err);
      $('#results').innerHTML = `<div class="empty">Failed to load the sheet. Please ensure the sheet is public ("Anyone with the link can view") and the ID is correct.<br><br><code>${escapeHtml(err.message)}</code></div>`;
      $('#resultsCounter').textContent = '0 items';
    }
  }

  // ---------- Filtering & Rendering ----------
  function applyFilters(ev){
    if (ev) ev.preventDefault();

    const level = $('#level').value;
    const subject = $('#subject').value;
    const banding = $('#banding').value;
    const compOnly = $('#compOnly').checked;
    const kw = $('#search').value.trim().toLowerCase();

    filtered = rawRows.filter(r =>
      (!level || r.level === level) &&
      (!subject || r.subject === subject) &&
      (!banding || r.banding === banding) &&
      (!compOnly || r.compulsory) &&
      (!kw || r.textbook.toLowerCase().includes(kw))
    );

    // Update dependent dropdowns as user goes
    populateFilters();

    renderGroups('#results', filtered);
    const n = filtered.length;
    $('#resultsCounter').textContent = n ? `${n} textbook${n>1?'s':''} shown` : 'No results';
  }

  function groupBySubjectBanding(rows){
    const map = new Map(); // subject -> Map(banding -> items[])
    for (const r of rows){
      if (!map.has(r.subject)) map.set(r.subject, new Map());
      const sub = map.get(r.subject);
      if (!sub.has(r.banding)) sub.set(r.banding, []);
      sub.get(r.banding).push(r);
    }
    // sort inside each banding by SN then textbook
    for (const [, bandMap] of map){
      for (const [, arr] of bandMap){
        arr.sort((a,b)=>{
          const snA = parseInt(a.sn,10), snB = parseInt(b.sn,10);
          if (!isNaN(snA) && !isNaN(snB) && snA!==snB) return snA-snB;
          return a.textbook.localeCompare(b.textbook,'en',{numeric:true});
        });
      }
    }
    return map;
  }

  function renderGroups(containerSel, rows){
    const container = $(containerSel);
    if (!rows.length){
      container.innerHTML = '<div class="empty">No results match your filters.</div>';
      return;
    }
    const map = groupBySubjectBanding(rows);
    const parts = [];
    // Sort subjects and bandings
    const subjects = [...map.keys()].sort((a,b)=>a.localeCompare(b,'en',{numeric:true}));
    for (const subj of subjects){
      const bandMap = map.get(subj);
      const bandings = [...bandMap.keys()].sort((a,b)=>a.localeCompare(b,'en',{numeric:true}));
      const inner = [];
      for (const b of bandings){
        const items = bandMap.get(b);
        inner.push(`
          <div class="subgroup">
            <div class="subhead">Banding: ${escapeHtml(b)} <span class="chip">${items.length} item${items.length>1?'s':''}</span></div>
            <ul class="list">
              ${items.map(it => `
                <li>
                  <span>${escapeHtml(it.textbook)}</span>
                  <span class="chips">
                    <span class="chip">Level ${escapeHtml(it.level)}</span>
                    ${it.compulsory ? '<span class="chip ok">Compulsory</span>' : ''}
                  </span>
                </li>
              `).join('')}
            </ul>
          </div>
        `);
      }
      parts.push(`
        <details class="group" open>
          <summary>
            <span>${escapeHtml(subj)}</span>
            <span class="spacer"></span>
            <span class="tag">${bandings.length} banding${bandings.length>1?'s':''}</span>
          </summary>
          ${inner.join('')}
        </details>
      `);
    }
    container.innerHTML = parts.join('');
  }

  // ---------- My List (persistent across adds, deduped) ----------
  function keyOf(r){ return [r.subject,r.banding,r.level,r.textbook].join('â—†'); }

  function addCurrentToMyList(){
    if (!filtered.length){
      showToast('No results to add.', 'warn');
      return;
    }
    let added = 0;
    for (const r of filtered){
      const k = keyOf(r);
      if (!myListMap.has(k)){
        myListMap.set(k, structuredClone(r));
        added++;
      }
    }
    renderMyList();
    showToast(added ? `Added ${added} item${added>1?'s':''} to My List` : 'All items were already in My List', added?'ok':'info');
  }

  function renderMyList(){
    const items = [...myListMap.values()];
    $('#myListEmpty').style.display = items.length ? 'none' : '';
    renderGroups('#myList', items);

    // meta text
    const listSummary = items.length ? `${items.length} total item${items.length>1?'s':''}` : 'Empty';
    const name = $('#studentName').value.trim();
    $('#myListMeta').textContent = (name ? `${name} â€¢ ` : '') + listSummary;
  }

  function clearMyList(){
    myListMap.clear();
    renderMyList();
    showToast('My List cleared');
  }

  // ---------- PDF (html2pdf.js renders HTML â†’ PDF; good for Chinese text) ----------
  function downloadPDF(){
    const name = $('#studentName').value.trim();
    const node = document.createElement('div');
    node.style.padding = '12px';
    node.style.background = '#ffffff';
    node.style.color = '#000000';
    node.innerHTML = `
      <div style="font-weight:700;font-size:18px;margin-bottom:6px">Book List${name?': '+escapeHtml(name):''}</div>
      <div style="font-size:12px;margin-bottom:10px;color:#111">Generated ${new Date().toLocaleString()}</div>
      ${document.querySelector('#myList').innerHTML || '<div>No items</div>'}
    `;
    // Ensure chips look nice on white
    node.querySelectorAll('.chip').forEach(el=>{
      el.style.background='#eef2f7'; el.style.border='1px solid #cfd7e3'; el.style.color='#111'; el.style.borderRadius='999px'; el.style.padding='2px 8px';
    });
    const opt = {
      margin:       10,
      filename:     `BookList${name?'-'+name.replace(/[\\/:*?"<>|]/g,''):''}.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak:    { mode: ['css','legacy'] }
    };
    html2pdf().set(opt).from(node).save();
  }

  // ---------- Events ----------
  $('#filtersForm').addEventListener('submit', applyFilters);
  $('#level').addEventListener('change', ()=>{ populateFilters(); applyFilters(); });
  $('#subject').addEventListener('change', ()=>{ populateFilters(); applyFilters(); });
  $('#banding').addEventListener('change', applyFilters);
  $('#compOnly').addEventListener('change', applyFilters);
  $('#search').addEventListener('input', ()=>{ /* live filter */ applyFilters(); });

  $('#resetBtn').addEventListener('click', ()=>{
    $('#level').value = '';
    $('#subject').value = '';
    $('#banding').value = '';
    $('#search').value = '';
    $('#compOnly').checked = false;
    populateFilters();
    applyFilters();
  });

  $('#addBtn').addEventListener('click', addCurrentToMyList);
  $('#clearBtn').addEventListener('click', clearMyList);
  $('#pdfBtn').addEventListener('click', downloadPDF);
  $('#studentName').addEventListener('input', renderMyList);

  // ---------- Init ----------
  loadSheet();
  </script>
</body>
</html>
