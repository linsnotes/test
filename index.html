<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Python Terminal with Multi-line Support</title>
    <!-- Include Brython core and standard library -->
    <script src="https://cdn.jsdelivr.net/npm/brython@3.11.1/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.11.1/brython_stdlib.js"></script>
    <style>
        body {
            font-family: "Courier New", Courier, monospace;
            background: #282c34;
            color: #61dafb;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
        }

        h1 {
            color: #61dafb;
            text-align: center;
            margin: 10px 0;
        }

        #terminal {
            background: #1e1e1e;
            border-radius: 5px;
            padding: 10px;
            max-width: 800px;
            margin: 0 auto;
            box-sizing: border-box;
            height: 60vh;
            overflow-y: auto;
        }

        #terminal-content {
            display: flex;
            flex-direction: column;
        }

        .input-line {
            display: flex;
            align-items: flex-start;
            color: #61dafb;
        }

        .prompt {
            margin-right: 5px;
            flex-shrink: 0;
        }

        .command-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            color: #61dafb;
            font-family: "Courier New", Courier, monospace;
            font-size: 16px;
            padding: 0;
            resize: none;
            overflow: hidden;
            min-height: 20px;
        }

        .command-input::placeholder {
            color: #777;
        }

        .output-line {
            color: #eee;
            margin-bottom: 5px;
            white-space: pre-wrap;
        }

        .error-line {
            color: #ff6b6b;
            margin-bottom: 5px;
            white-space: pre-wrap;
        }

        .command-line {
            color: #61dafb;
            margin-bottom: 5px;
            white-space: pre-wrap;
        }

        @media (max-width: 600px) {
            body {
                padding: 5px;
            }

            #terminal {
                padding: 5px;
                height: 70vh;
            }

            .command-input {
                font-size: 14px;
            }
        }
    </style>
</head>
<body onload="brython()">
    <h1>Python Terminal Emulator</h1>
    <div id="terminal">
        <div id="terminal-content">
            <div class="output-line">Welcome to the Python Terminal! Type your commands below:</div>
            <!-- Initial input line -->
            <div class="input-line">
                <span class="prompt">>>> </span>
                <textarea class="command-input" autofocus rows="1"></textarea>
            </div>
        </div>
    </div>

    <script type="text/python">
        from browser import document, window, html
        import sys
        import traceback
        import code

        terminal = document["terminal-content"]

        # Initialize global namespace
        global_namespace = {}

        # State variables
        code_buffer = []
        more_input_needed = False

        # Capture print statements
        class StdoutCatcher:
            def __init__(self):
                self.data = ''

            def write(self, s):
                self.data += s

            def flush(self):
                pass

        def handle_command(event):
            if event.key == "Enter" and not event.shiftKey:
                event.preventDefault()
                command_input = event.target
                command = command_input.value.rstrip()

                # Append command to code buffer
                code_buffer.append(command)

                source = '\n'.join(code_buffer)

                # Check if code is complete
                try:
                    compiled_code = code.compile_command(source)
                    if compiled_code is None:
                        # Incomplete code
                        display_input(command_input, prompt='... ')
                        create_new_input_line(more_input_needed=True)
                        return
                    else:
                        # Complete code
                        display_input(command_input)
                        execute_code(source)
                        code_buffer.clear()
                except Exception as e:
                    # Syntax error
                    display_input(command_input)
                    execute_code(source)
                    code_buffer.clear()

                # Scroll to the bottom
                terminal.scrollTop = terminal.scrollHeight

                # Create a new input line
                create_new_input_line()
            elif event.key == "Enter" and event.shiftKey:
                # Allow line break with Shift+Enter
                command_input.rows += 1

        def display_input(command_input, prompt='>>> '):
            # Display the entered command
            lines = command_input.value.rstrip().split('\n')
            command_display = '\n'.join([prompt + line for line in lines])

            command_line = document.createElement("div")
            command_line.className = "command-line"
            command_line.textContent = command_display
            terminal.insertBefore(command_line, command_input.parentNode)

            # Remove the old input line
            command_input.parentNode.remove()

        def execute_code(source):
            # Prepare stdout catcher
            stdout_catcher = StdoutCatcher()
            sys.stdout = stdout_catcher

            try:
                # Special commands handling
                command = source.strip()
                if command == "clear":
                    # Clear the terminal content
                    terminal.textContent = ''
                elif command == "ls":
                    # Simulate 'ls' by listing variables in global namespace
                    vars_list = ', '.join(global_namespace.keys()) or 'No variables defined.'
                    output_line = document.createElement("div")
                    output_line.className = "output-line"
                    output_line.textContent = vars_list
                    terminal.insertBefore(output_line, None)
                elif command.startswith("pip"):
                    # Simulate 'pip' command
                    output_line = document.createElement("div")
                    output_line.className = "output-line"
                    output_line.textContent = "Error: 'pip' command is not available in this environment."
                    terminal.insertBefore(output_line, None)
                else:
                    exec(source, global_namespace)
                    # Check if there was any print output
                    if stdout_catcher.data:
                        output_line = document.createElement("div")
                        output_line.className = "output-line"
                        output_line.textContent = stdout_catcher.data
                        terminal.insertBefore(output_line, None)
            except Exception as e:
                # Display errors
                error_line = document.createElement("div")
                error_line.className = "error-line"
                error_line.textContent = ''.join(traceback.format_exception_only(type(e), e))
                terminal.insertBefore(error_line, None)
            finally:
                sys.stdout = sys.__stdout__

        def create_new_input_line(more_input_needed=False):
            # Create a new input line div
            input_line_div = document.createElement("div")
            input_line_div.className = "input-line"

            # Create prompt span
            prompt_span = document.createElement("span")
            prompt_span.className = "prompt"
            prompt_span.textContent = '... ' if more_input_needed else '>>> '

            # Create textarea element
            input_element = document.createElement("textarea")
            input_element.className = "command-input"
            input_element.rows = 1
            input_element.autofocus = True

            # Bind the event listener
            input_element.bind("keydown", handle_command)

            # Append elements
            input_line_div <= prompt_span
            input_line_div <= input_element
            terminal <= input_line_div

            # Focus on the new input
            input_element.focus()
            # Adjust state
            window.more_input_needed = more_input_needed

        # Start by focusing on the first input
        initial_input = document.querySelector(".command-input")
        initial_input.bind("keydown", handle_command)
        initial_input.focus()
    </script>
</body>
</html>
